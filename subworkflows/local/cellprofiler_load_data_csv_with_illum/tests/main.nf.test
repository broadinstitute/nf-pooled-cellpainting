nextflow_workflow {

    name "Test Subworkflow CELLPROFILER_LOAD_DATA_CSV_WITH_ILLUM"
    script "../main.nf"
    workflow "CELLPROFILER_LOAD_DATA_CSV_WITH_ILLUM"

    tag "subworkflows"
    tag "subworkflows_local"
    tag "cellprofiler_load_data_csv_with_illum"

    test("cellpainting - multi-channel - group by batch,plate,channels,well") {
        
        when {
            workflow {
                """
                // Create a channel that mimics the processed samplesheet after splitting channels
                input[0] = Channel.of(
                    [[arm:'CP', batch:'Batch1', plate:'Plate1', well:'A1', site:0, cycle:1, channels:'Phalloidin', n_frames:3, original_channels:'Phalloidin,CHN2-AF488,DNA'], file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1_sub25/Source1/images/Batch1/images/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0000_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0000.ome.tiff")],
                    [[arm:'CP', batch:'Batch1', plate:'Plate1', well:'A1', site:0, cycle:1, channels:'CHN2-AF488', n_frames:3, original_channels:'Phalloidin,CHN2-AF488,DNA'], file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1_sub25/Source1/images/Batch1/images/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0000_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0000.ome.tiff")],
                    [[arm:'CP', batch:'Batch1', plate:'Plate1', well:'A1', site:0, cycle:1, channels:'DNA', n_frames:3, original_channels:'Phalloidin,CHN2-AF488,DNA'], file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1_sub25/Source1/images/Batch1/images/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0000_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0000.ome.tiff")],
                    [[arm:'CP', batch:'Batch1', plate:'Plate1', well:'A1', site:1, cycle:1, channels:'Phalloidin', n_frames:3, original_channels:'Phalloidin,CHN2-AF488,DNA'], file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1_sub25/Source1/images/Batch1/images/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0001_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0001.ome.tiff")],
                    [[arm:'CP', batch:'Batch1', plate:'Plate1', well:'A1', site:1, cycle:1, channels:'CHN2-AF488', n_frames:3, original_channels:'Phalloidin,CHN2-AF488,DNA'], file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1_sub25/Source1/images/Batch1/images/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0001_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0001.ome.tiff")],
                    [[arm:'CP', batch:'Batch1', plate:'Plate1', well:'A1', site:1, cycle:1, channels:'DNA', n_frames:3, original_channels:'Phalloidin,CHN2-AF488,DNA'], file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1_sub25/Source1/images/Batch1/images/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0001_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0001.ome.tiff")],
                    [[arm:'CP', batch:'Batch1', plate:'Plate1', well:'A2', site:0, cycle:1, channels:'Phalloidin', n_frames:3, original_channels:'Phalloidin,CHN2-AF488,DNA'], file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1_sub25/Source1/images/Batch1/images/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA2_PointA2_0000_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq1025.ome.tiff")],
                    [[arm:'CP', batch:'Batch1', plate:'Plate1', well:'A2', site:0, cycle:1, channels:'CHN2-AF488', n_frames:3, original_channels:'Phalloidin,CHN2-AF488,DNA'], file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1_sub25/Source1/images/Batch1/images/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA2_PointA2_0000_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq1025.ome.tiff")],
                    [[arm:'CP', batch:'Batch1', plate:'Plate1', well:'A2', site:0, cycle:1, channels:'DNA', n_frames:3, original_channels:'Phalloidin,CHN2-AF488,DNA'], file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1_sub25/Source1/images/Batch1/images/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA2_PointA2_0000_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq1025.ome.tiff")]
                )
                input[1] = ['batch', 'plate','arm','well']
                input[2] = Channel.of(
                    [[batch:'Batch1', plate:'Plate1'], [
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/illum/Plate1/Plate1_IllumPhalloidin.npy"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/illum/Plate1/Plate1_IllumCHN2.npy"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/illum/Plate1/Plate1_IllumDNA.npy")
                    ]]
                )
                input[3] = "illumination_cp_apply"
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert snapshot(workflow.out.images_with_load_data_csv).match() }
            )
        }
    }

}