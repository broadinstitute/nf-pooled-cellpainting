# Pixi configuration for nf-pooled-cellpainting
# https://pixi.sh/latest/reference/pixi_manifest/

[workspace]
name = "nf-pooled-cellpainting"
description = "Nextflow pipeline for processing optical pooled screening (OPS) data"
channels = ["conda-forge", "bioconda"]
platforms = ["osx-arm64", "osx-64", "linux-64"]
repository = "https://github.com/broadinstitute/nf-pooled-cellpainting"
license = "MIT"

# =============================================================================
# Base Dependencies - Core tools needed for pipeline development
# =============================================================================
[dependencies]
python = ">=3.11"
nextflow = ">=24.0"
nf-test = ">=0.9"
nf-core = ">=3.0"

# =============================================================================
# Features - Modular dependency groups
# =============================================================================

# Documentation tools
[feature.docs.dependencies]
mkdocs = ">=1.5.0"
mkdocs-material = ">=9.5.0"
mkdocs-macros-plugin = ">=1.0.0"
pymdown-extensions = ">=10.7.0"

# Development tools (linting, formatting)
[feature.dev.dependencies]
pre-commit = ">=3.0"
prettier = ">=3.0"

# =============================================================================
# Environments - Combine features for different use cases
# =============================================================================
[environments]
default = { features = [], solve-group = "default" }
docs = { features = ["docs"], solve-group = "default" }
dev = { features = ["dev"], solve-group = "default" }
all = { features = ["docs", "dev"], solve-group = "default" }

# =============================================================================
# Tasks - Common development workflows
# =============================================================================

# Pipeline execution
[tasks]
preview = { cmd = "nextflow run main.nf -profile test,docker --outdir results -preview", description = "Dry-run pipeline to check workflow logic" }
run-test = { cmd = "nextflow run main.nf -profile test,docker --outdir results", description = "Run pipeline with test profile" }

# Testing
[tasks.test]
cmd = "nf-test test --profile debug,test,docker --verbose"
description = "Run all nf-test tests"

[tasks.test-illumcalc]
cmd = "nf-test test modules/local/cellprofiler/illumcalc/tests/main.nf.test --profile debug,test,docker"
description = "Quick test: illumination calculation module (~30s)"

[tasks.test-segcheck]
cmd = "nf-test test modules/local/cellprofiler/segcheck/tests/main.nf.test --profile debug,test,docker"
description = "Quick test: segmentation check module (~30s)"

[tasks.test-quick]
cmd = "nf-test test modules/local/cellprofiler/illumcalc/tests/main.nf.test modules/local/cellprofiler/segcheck/tests/main.nf.test --profile debug,test,docker"
description = "Run quick module tests (illumcalc + segcheck)"

[tasks.test-full]
cmd = "nf-test test tests/main.nf.test --profile debug,test,docker --verbose"
description = "Run full pipeline test (slow, 5-10+ minutes)"

# Linting
[tasks.lint]
cmd = "nf-core pipelines lint"
description = "Lint the pipeline with nf-core"

# Schema management
[tasks.schema-build]
cmd = "nf-core pipelines schema build --dir ."
description = "Update schema after adding parameters"

# Documentation (requires docs environment)
[feature.docs.tasks]
docs-serve = { cmd = "mkdocs serve", description = "Serve documentation locally" }
docs-build = { cmd = "mkdocs build", description = "Build documentation" }

# Clean up
[tasks.clean]
cmd = "rm -rf work results .nextflow .nextflow.log*"
description = "Clean Nextflow work directory and results"

[tasks.clean-all]
cmd = "rm -rf work results .nextflow .nextflow.log* .nf-test"
description = "Clean all generated files including nf-test cache"
