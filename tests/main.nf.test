nextflow_pipeline {

    name "Test Workflow NF_POOLED_CELLPAINTING"
    script "main.nf"

    tag "pipeline"
    tag "nf_pooled_cellpainting"

    test("nf-pooled-cellpainting - full pipeline - test profile") {

        when {
            params {
                // Use the test profile parameters
                config_profile_name         = 'Test profile'
                config_profile_description  = 'Minimal test dataset to check pipeline function'

                // Input data
                input                       = "${projectDir}/assets/samplesheet.csv"
                barcodes                    = "s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1_sub25/Source1/workspace/metadata/Barcodes.csv"
                range_skip                  = 2
                fiji_stitchcrop_script      = "${projectDir}/bin/stitch_crop.test.py"

                painting_illumcalc_cppipe   = "${projectDir}/assets/cellprofiler/painting_illumcalc_cppipe.template"
                painting_illumapply_cppipe  = "${projectDir}/assets/cellprofiler/painting_illumapply.cppipe"
                painting_segcheck_cppipe    = "${projectDir}/assets/cellprofiler/painting_segcheck.cppipe"
                barcoding_illumcalc_cppipe  = "${projectDir}/assets/cellprofiler/barcoding_illumcalc_cppipe.template"
                barcoding_illumapply_cppipe = "${projectDir}/assets/cellprofiler/barcoding_illumapply.cppipe"
                barcoding_preprocess_cppipe = "${projectDir}/assets/cellprofiler/barcoding_preprocess.cppipe"
                combinedanalysis_cppipe     = "${projectDir}/assets/cellprofiler/combined_analysis.cppipe"

                // Stitching/Cropping parameters - Painting-specific
                painting_round_or_square    = "square"
                painting_quarter_if_round   = true
                painting_overlap_pct        = 10
                painting_scalingstring      = 2
                painting_imperwell          = "unused"
                painting_rows               = 2
                painting_columns            = 2
                painting_stitchorder        = "Grid: snake by rows"

                // Stitching/Cropping parameters - Barcoding-specific
                barcoding_round_or_square   = "square"
                barcoding_quarter_if_round  = true
                barcoding_overlap_pct       = 10
                barcoding_scalingstring     = 2
                barcoding_imperwell         = "unused"
                barcoding_rows              = 2
                barcoding_columns           = 2
                barcoding_stitchorder       = "Grid: snake by rows"

                tileperside                 = 2
                final_tile_size             = 800

                // Output directory
                outdir                      = "${outputDir}"
            }
        }

        then {
            // stable_name: All files + folders in ${params.outdir}/ with a stable name
            def stable_name = getAllFilesFromDir(params.outdir, relative: true, includeDir: true, ignore: ['pipeline_info/*.{html,json,txt}'])
            // stable_path: All files in ${params.outdir}/ with stable content
            def stable_path = getAllFilesFromDir(params.outdir, ignoreFile: 'tests/.nftignore')
            assert workflow.success
            assertAll(
                { assert workflow.success},
                { assert snapshot(
                    // Number of successful tasks
                    workflow.trace.succeeded().size(),
                    // pipeline versions.yml file for multiqc from which Nextflow version is removed because we tests pipelines on multiple Nextflow versions
                    removeNextflowVersion("$outputDir/pipeline_info/nf-pooled-cellpainting_software_mqc_versions.yml"),
                    // All stable path name, with a relative path
                    stable_name,
                    // All files with stable contents
                    stable_path
                ).match() }
            )
        }
    }

    test("nf-pooled-cellpainting - full pipeline - test profile - stub") {

        options "-stub"

        when {
            params {
                // Use the test profile parameters
                config_profile_name         = 'Test profile'
                config_profile_description  = 'Minimal test dataset to check pipeline function'

                // Input data
                input                       = "${projectDir}/assets/samplesheet.csv"
                barcodes                    = "s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1_sub25/Source1/workspace/metadata/Barcodes.csv"
                range_skip                  = 2
                fiji_stitchcrop_script      = "${projectDir}/bin/stitch_crop.test.py"

                painting_illumcalc_cppipe   = "${projectDir}/assets/cellprofiler/painting_illumcalc_cppipe.template"
                painting_illumapply_cppipe  = "${projectDir}/assets/cellprofiler/painting_illumapply.cppipe"
                painting_segcheck_cppipe    = "${projectDir}/assets/cellprofiler/painting_segcheck.cppipe"
                barcoding_illumcalc_cppipe  = "${projectDir}/assets/cellprofiler/barcoding_illumcalc_cppipe.template"
                barcoding_illumapply_cppipe = "${projectDir}/assets/cellprofiler/barcoding_illumapply.cppipe"
                barcoding_preprocess_cppipe = "${projectDir}/assets/cellprofiler/barcoding_preprocess.cppipe"
                combinedanalysis_cppipe     = "${projectDir}/assets/cellprofiler/combined_analysis.cppipe"

                // Cellprofiler plugins
                callbarcodes_plugin         = "${projectDir}/assets/cellprofiler_plugins/callbarcodes.py"
                compensatecolors_plugin     = "${projectDir}/assets/cellprofiler_plugins/compensatecolors.py"

                // Stitching/Cropping parameters - Painting-specific
                painting_round_or_square    = "square"
                painting_quarter_if_round   = true
                painting_overlap_pct        = 10
                painting_scalingstring      = 2
                painting_imperwell          = "unused"
                painting_rows               = 2
                painting_columns            = 2
                painting_stitchorder        = "Grid: snake by rows"

                // Stitching/Cropping parameters - Barcoding-specific
                barcoding_round_or_square   = "square"
                barcoding_quarter_if_round  = true
                barcoding_overlap_pct       = 10
                barcoding_scalingstring     = 2
                barcoding_imperwell         = "unused"
                barcoding_rows              = 2
                barcoding_columns           = 2
                barcoding_stitchorder       = "Grid: snake by rows"

                tileperside                 = 2
                final_tile_size             = 800

                // Output directory
                outdir                      = "${outputDir}"
            }
        }

        then {
            // stable_name: All files + folders in ${params.outdir}/ with a stable name
            def stable_name = getAllFilesFromDir(params.outdir, relative: true, includeDir: true, ignore: ['pipeline_info/*.{html,json,txt}'])
            // stable_path: All files in ${params.outdir}/ with stable content
            def stable_path = getAllFilesFromDir(params.outdir, ignoreFile: 'tests/.nftignore')
            assertAll(
                { assert workflow.success},
                { assert snapshot(
                    // Number of successful tasks
                    workflow.trace.succeeded().size(),
                    // All stable path name, with a relative path
                    stable_name,
                    // All files with stable contents
                    stable_path
                ).match() }
            )
        }
    }
}
