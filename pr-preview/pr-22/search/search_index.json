{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"nf-pooled-cellpainting","text":"<p>A high-throughput Nextflow pipeline for optical pooled screening combining Cell Painting phenotypic analysis with sequencing-by-synthesis barcoding.</p>"},{"location":"#overview","title":"Overview","text":"<p>This pipeline processes optical pooled screening (OPS) data through two parallel processing arms:</p> <ul> <li>Cell Painting Arm: Phenotypic profiling using multi-channel fluorescence microscopy</li> <li>Barcoding Arm: Genetic identification using sequencing-by-synthesis (SBS)</li> </ul> <p>The pipeline includes extensive quality control checkpoints, automated image stitching, and combined analysis for comprehensive screening results.</p>"},{"location":"#repository-structure","title":"Repository Structure","text":"<pre><code>nf-pooled-cellpainting/\n\u251c\u2500\u2500 main.nf                    # Entry point\n\u251c\u2500\u2500 nextflow.config            # Main configuration\n\u251c\u2500\u2500 workflows/                 # Main workflow logic\n\u2502   \u2514\u2500\u2500 nf-pooled-cellpainting.nf\n\u251c\u2500\u2500 subworkflows/local/        # Pipeline subworkflows\n\u2502   \u251c\u2500\u2500 cellpainting/          # Cell painting processing arm\n\u2502   \u251c\u2500\u2500 barcoding/             # Barcoding processing arm\n\u2502   \u2514\u2500\u2500 utils*/                # Utility subworkflows\n\u251c\u2500\u2500 modules/local/             # Local process modules\n\u2502   \u251c\u2500\u2500 cellprofiler/          # CellProfiler processes\n\u2502   \u2502   \u251c\u2500\u2500 illumcalc/         # Illumination calculation\n\u2502   \u2502   \u251c\u2500\u2500 illumapply/        # Illumination application\n\u2502   \u2502   \u251c\u2500\u2500 preprocess/        # Barcode preprocessing\n\u2502   \u2502   \u251c\u2500\u2500 segcheck/          # Segmentation QC\n\u2502   \u2502   \u2514\u2500\u2500 combinedanalysis/  # Combined analysis\n\u2502   \u251c\u2500\u2500 fiji/                  # Fiji image processing\n\u2502   \u2502   \u2514\u2500\u2500 stitchcrop/        # Image stitching &amp; cropping\n\u2502   \u2514\u2500\u2500 qc/                    # QC modules\n\u251c\u2500\u2500 bin/                       # Python scripts &amp; tools\n\u251c\u2500\u2500 conf/                      # Configuration files\n\u251c\u2500\u2500 assets/                    # CellProfiler pipelines &amp; resources\n\u251c\u2500\u2500 docs/                      # Documentation source\n\u2514\u2500\u2500 tests/                     # nf-test test cases\n</code></pre>"},{"location":"#key-features","title":"Key Features","text":"<ul> <li>Dual-arm processing for painting and barcoding data</li> <li>Illumination correction via CellProfiler</li> <li>Quality control gates at critical pipeline stages</li> <li>Automated image stitching with Fiji</li> <li>Flexible parallelization at plate, well, and site levels</li> <li>CellProfiler plugin support for barcode calling and color compensation</li> <li>Seqera Platform ready for cloud and HPC execution</li> </ul>"},{"location":"#quick-links","title":"Quick Links","text":"<ul> <li>Getting Started - Install and run your first analysis</li> <li>Parameters - Complete parameter reference</li> <li>Architecture - Pipeline architecture and implementation</li> <li>Seqera Platform - Run on cloud and HPC infrastructure</li> </ul>"},{"location":"#citation","title":"Citation","text":"<p>If you use this pipeline, please cite the original authors and tools:</p> <p>Pipeline Authors: Florian Wuennemann, Erin Weisbart, Shantanu Singh, Ken Brewer</p> <p>Key Tools:</p> <ul> <li>CellProfiler (Carpenter et al., 2006)</li> <li>Fiji/ImageJ (Schindelin et al., 2012)</li> <li>Nextflow (Di Tommaso et al., 2017)</li> </ul> <p>See CITATIONS.md for complete citations.</p>"},{"location":"#support","title":"Support","text":"<p>For questions and support:</p> <ul> <li>Open an issue on GitHub</li> <li>Review Troubleshooting Guide</li> </ul>"},{"location":"#license","title":"License","text":"<p>This pipeline uses code and infrastructure from the nf-core community, reused under the MIT license.</p>"},{"location":"load_data_csv_generation/","title":"Load Data CSV Generation - Current Implementation","text":"<p>Last Updated: 2025-11-12 Purpose: Documentation of current approach for generating <code>load_data.csv</code> files for CellProfiler processes</p>"},{"location":"load_data_csv_generation/#overview","title":"Overview","text":"<p>The pipeline generates <code>load_data.csv</code> files for CellProfiler using Python scripts. Metadata (Batch, Plate, Well, Site) originates from the input samplesheet and flows through Nextflow channels, with different processes using either metadata-driven or filename-driven approaches.</p>"},{"location":"load_data_csv_generation/#metadata-sources","title":"Metadata Sources","text":""},{"location":"load_data_csv_generation/#input-samplesheet","title":"Input Samplesheet","text":"<p>Location: User-provided CSV (e.g., <code>assets/samplesheet.csv</code>) Schema: <code>assets/schema_input.json</code></p> <p>Required Columns:</p> <pre><code>path,arm,batch,plate,well,site,channels,cycle,n_frames\n</code></pre> <p>Example:</p> <pre><code>s3://bucket/WellA1_PointA1_0000_ChannelPhalloidin,CHN2,DNA_Seq0000.ome.tiff,painting,Batch1,Plate1,A1,1,\"Phalloidin,CHN2,DNA\",1,3\n</code></pre>"},{"location":"load_data_csv_generation/#metadata-flow-through-pipeline","title":"Metadata Flow Through Pipeline","text":"<p>Entry Point: <code>main.nf:57-70</code></p> <ul> <li>Parses samplesheet using <code>samplesheetToList()</code> plugin</li> <li>Creates channels with structure: <code>[meta, image_path]</code></li> </ul> <p>Meta Map Structure:</p> <pre><code>[\n    batch: \"Batch1\",\n    plate: \"Plate1\",\n    well: \"A1\",\n    site: 1,\n    cycle: 1,  // barcoding only\n    channels: \"Phalloidin,CHN2,DNA\",\n    arm: \"painting\" | \"barcoding\",\n    id: \"Batch1_Plate1_A1\"  // auto-generated\n]\n</code></pre>"},{"location":"load_data_csv_generation/#python-scripts","title":"Python Scripts","text":""},{"location":"load_data_csv_generation/#1-generate_load_data_csvpy","title":"1. generate_load_data_csv.py","text":"<p>Location: <code>bin/generate_load_data_csv.py</code> Purpose: General-purpose CSV generator for all pipeline stages</p> <p>Supported Pipeline Types:</p> <ul> <li><code>illumcalc</code> - Illumination calculation</li> <li><code>illumapply</code> - Illumination correction</li> <li><code>segcheck</code> - Segmentation QC</li> <li><code>analysis</code> - Full analysis</li> <li><code>preprocess</code> - Barcoding preprocessing</li> <li><code>combined</code> - Combined painting + barcoding</li> </ul> <p>Key Functions:</p> Function Lines Purpose <code>parse_original_image()</code> 83-138 Parse: <code>WellA1_PointA1_0000_ChannelCHN1,CHN2_Seq0000.ome.tiff</code> <code>parse_corrected_image()</code> 141-159 Parse: <code>Plate_{plate}_Well_{well}_Site_{site}_Corr{channel}.tiff</code> <code>parse_preprocess_image()</code> 162-197 Parse: <code>Plate_{plate}_Well_{well}_Site_{site}_Cycle{cycle}_{channel}.tiff</code> <code>collect_and_group_files()</code> 408-676 Group files by (plate, well, site) <code>generate_csv_rows()</code> 679-897 Create CSV rows with metadata columns"},{"location":"load_data_csv_generation/#2-generate_combined_load_datapy","title":"2. generate_combined_load_data.py","text":"<p>Location: <code>bin/generate_combined_load_data.py</code> Purpose: Specialized CSV for combined analysis (painting + barcoding)</p> <p>Key Functions:</p> Function Lines Purpose <code>parse_combined_image()</code> 20-60 Parse both corrected and cycle-specific images <code>collect_and_group_files()</code> 90-187 Group and separate barcoding vs cellpainting <code>generate_csv_rows()</code> 190-257 Create unified CSV with both image types"},{"location":"load_data_csv_generation/#process-implementations","title":"Process Implementations","text":""},{"location":"load_data_csv_generation/#pattern-a-metadata-driven","title":"Pattern A: Metadata-Driven","text":"<p>Processes: ILLUMCALC, ILLUMAPPLY Approach: Pass metadata as CLI arguments to Python script</p>"},{"location":"load_data_csv_generation/#cellprofiler_illumcalc","title":"CELLPROFILER_ILLUMCALC","text":"<p>File: <code>modules/local/cellprofiler/illumcalc/main.nf:28-36</code></p> <pre><code>generate_load_data_csv.py \\\n    --pipeline-type illumcalc \\\n    --images-dir ./images \\\n    --output load_data.csv \\\n    --channels \"${channels}\" \\        # from meta.channels\n    --cycle ${cycle} \\                # from meta.cycle (if barcoding)\n    --plate ${meta.plate} \\           # SOURCE: meta.plate\n    --has-cycles                      # if barcoding\n</code></pre> <p>Metadata Passed:</p> <ul> <li><code>meta.plate</code> \u2192 <code>--plate</code> \u2192 <code>Metadata_Plate</code> column</li> <li><code>meta.channels</code> \u2192 <code>--channels</code> \u2192 column headers</li> <li><code>meta.cycle</code> \u2192 <code>--cycle</code> \u2192 <code>Metadata_Cycle</code> column</li> </ul> <p>Parsed from Filenames:</p> <ul> <li>Well (e.g., \"A1\" from \"WellA1_...\")</li> <li>Site (numeric from \"Point{site}_...\")</li> </ul>"},{"location":"load_data_csv_generation/#cellprofiler_illumapply","title":"CELLPROFILER_ILLUMAPPLY","text":"<p>File: <code>modules/local/cellprofiler/illumapply/main.nf:28-36</code></p> <pre><code>generate_load_data_csv.py \\\n    --pipeline-type illumapply \\\n    --images-dir ./images \\\n    --illum-dir ./images \\\n    --output load_data.csv \\\n    --channels \"${channels}\" \\        # from meta.channels\n    --cycles ${cycles.join(',')} \\    # from meta (if multi-cycle)\n    --plate ${meta.plate} \\           # SOURCE: meta.plate\n    --has-cycles                      # if barcoding\n</code></pre> <p>Metadata Passed:</p> <ul> <li><code>meta.plate</code> \u2192 <code>Metadata_Plate</code></li> <li><code>meta.channels</code> \u2192 column headers</li> </ul> <p>Parsed from Filenames:</p> <ul> <li>Well</li> <li>Site</li> </ul>"},{"location":"load_data_csv_generation/#pattern-b-filename-driven","title":"Pattern B: Filename-Driven","text":"<p>Processes: PREPROCESS, COMBINEDANALYSIS Approach: Extract ALL metadata from standardized filenames</p>"},{"location":"load_data_csv_generation/#cellprofiler_preprocess","title":"CELLPROFILER_PREPROCESS","text":"<p>File: <code>modules/local/cellprofiler/preprocess/main.nf:30-33</code></p> <pre><code>generate_load_data_csv.py \\\n    --pipeline-type preprocess \\\n    --images-dir ./images \\\n    --output load_data.csv\n</code></pre> <p>All Metadata Parsed from Filename:</p> <ul> <li>Pattern: <code>Plate_{plate}_Well_{well}_Site_{site}_Cycle{cycle}_{channel}.tiff</code></li> <li>Example: <code>Plate_Plate1_Well_A1_Site_1_Cycle01_A.tiff</code></li> </ul>"},{"location":"load_data_csv_generation/#cellprofiler_combinedanalysis","title":"CELLPROFILER_COMBINEDANALYSIS","text":"<p>File: <code>modules/local/cellprofiler/combinedanalysis/main.nf:34-36</code></p> <pre><code>generate_combined_load_data.py \\\n    --images-dir ./images \\\n    --output load_data.csv\n</code></pre> <p>Handles Two Filename Patterns:</p> <ol> <li>Cell Painting: <code>Plate_{plate}_Well_{well}_Site_{site}_Corr{channel}.tiff</code></li> <li>Barcoding: <code>Plate_{plate}_Well_{well}_Site_{site}_Cycle{cycle}_{channel}.tiff</code></li> </ol>"},{"location":"load_data_csv_generation/#metadata-field-sources","title":"Metadata Field Sources","text":"Field Primary Source Fallback Used In CSV Code Location Batch Samplesheet \u2192 <code>meta.batch</code> - No (grouping only) <code>main.nf:69</code> Plate Samplesheet \u2192 <code>meta.plate</code> \u2192 <code>--plate</code> arg Parsed from filename/path Yes: <code>Metadata_Plate</code> <code>generate_load_data_csv.py:492, 736</code> Well Parsed from filename Samplesheet <code>meta.well</code> (not passed) Yes: <code>Metadata_Well</code> <code>parse_*_image()</code> functions Site Parsed from filename Samplesheet <code>meta.site</code> (not passed) Yes: <code>Metadata_Site</code> <code>parse_*_image()</code> functions Cycle Samplesheet \u2192 <code>meta.cycle</code> \u2192 <code>--cycle</code> arg Parsed from filename Yes: <code>Metadata_Cycle</code> <code>generate_load_data_csv.py:745-748</code> Channels Samplesheet \u2192 <code>meta.channels</code> \u2192 <code>--channels</code> arg Parsed from filename Yes: Column headers <code>generate_load_data_csv.py:813, 766</code>"},{"location":"load_data_csv_generation/#csv-output-structures","title":"CSV Output Structures","text":""},{"location":"load_data_csv_generation/#standard-cell-painting-illumapply","title":"Standard (Cell Painting ILLUMAPPLY)","text":"<pre><code>Metadata_Plate,Metadata_Well,Metadata_Site,FileName_OrigDNA,Frame_OrigDNA,FileName_IllumDNA,...\nPlate1,A1,1,WellA1_Point_0000.ome.tiff,0,Plate1_IllumDNA.npy,...\n</code></pre>"},{"location":"load_data_csv_generation/#with-cycles-barcoding-illumapply","title":"With Cycles (Barcoding ILLUMAPPLY)","text":"<pre><code>Metadata_Plate,Metadata_Well,Metadata_Site,Metadata_Cycle,FileName_Cycle01_OrigA,Frame_Cycle01_OrigA,...\nPlate1,A1,1,1,filename.ome.tiff,0,...\n</code></pre>"},{"location":"load_data_csv_generation/#preprocess","title":"Preprocess","text":"<pre><code>Metadata_Plate,Metadata_Site,Metadata_Well,Metadata_Well_Value,FileName_Cycle01_A,FileName_Cycle01_C,...\nPlate1,1,A1,A1,file1.tiff,file2.tiff,...\n</code></pre>"},{"location":"load_data_csv_generation/#combined-analysis","title":"Combined Analysis","text":"<pre><code>Metadata_Plate,Metadata_Site,Metadata_Well,Metadata_Well_Value,FileName_CorrDNA,FileName_Cycle01_A,...\nPlate1,1,A1,A1,corrected.tiff,cycle1.tiff,...\n</code></pre>"},{"location":"load_data_csv_generation/#data-flow-example","title":"Data Flow Example","text":""},{"location":"load_data_csv_generation/#input","title":"Input","text":"<p>Samplesheet Row:</p> <pre><code>s3://bucket/WellA1_Point_0000.ome.tiff,painting,Batch1,Plate1,A1,\"DNA,Phalloidin\",1,1,3\n</code></pre>"},{"location":"load_data_csv_generation/#processing","title":"Processing","text":"<p>Channel Element (after parsing):</p> <pre><code>[\n    [batch: \"Batch1\", plate: \"Plate1\", well: \"A1\", site: 1,\n     channels: \"DNA,Phalloidin\", arm: \"painting\"],\n    \"s3://bucket/WellA1_Point_0000.ome.tiff\"\n]\n</code></pre> <p>After ILLUMCALC (outputs per plate):</p> <pre><code>Plate1_IllumDNA.npy\nPlate1_IllumPhalloidin.npy\n</code></pre> <p>After ILLUMAPPLY (outputs per well+site):</p> <pre><code>Plate_Plate1_Well_A1_Site_1_CorrDNA.tiff\nPlate_Plate1_Well_A1_Site_1_CorrPhalloidin.tiff\n</code></pre>"},{"location":"load_data_csv_generation/#output","title":"Output","text":"<p>ILLUMAPPLY load_data.csv:</p> <pre><code>Metadata_Plate,Metadata_Well,Metadata_Site,FileName_OrigDNA,Frame_OrigDNA,FileName_IllumDNA,FileName_OrigPhalloidin,Frame_OrigPhalloidin,FileName_IllumPhalloidin\nPlate1,A1,1,WellA1_Point_0000.ome.tiff,0,Plate1_IllumDNA.npy,WellA1_Point_0000.ome.tiff,1,Plate1_IllumPhalloidin.npy\n</code></pre>"},{"location":"load_data_csv_generation/#channel-grouping-strategies","title":"Channel Grouping Strategies","text":""},{"location":"load_data_csv_generation/#cellpainting-subworkflow","title":"Cellpainting Subworkflow","text":"<p>File: <code>subworkflows/local/cellpainting/main.nf</code></p> <p>For ILLUMCALC (lines 30-46):</p> <pre><code>group_key = [\n    batch: meta.batch,\n    plate: meta.plate,\n    id: \"${meta.batch}_${meta.plate}\"\n]\n// Groups all images from same batch+plate\n</code></pre> <p>For ILLUMAPPLY (lines 84-101):</p> <pre><code>group_key = [\n    batch: meta.batch,\n    plate: meta.plate,\n    well: meta.well,\n    arm: meta.arm,\n    id: \"${meta.batch}_${meta.plate}_${meta.well}\"\n]\n// Groups all sites from same well\n</code></pre>"},{"location":"load_data_csv_generation/#barcoding-subworkflow","title":"Barcoding Subworkflow","text":"<p>File: <code>subworkflows/local/barcoding/main.nf</code></p> <p>For ILLUMCALC (lines 30-47):</p> <pre><code>group_key = [\n    batch: meta.batch,\n    plate: meta.plate,\n    cycle: meta.cycle,\n    id: \"${meta.batch}_${meta.plate}_${meta.cycle}\"\n]\n// Groups all images from same batch+plate+cycle\n</code></pre> <p>For ILLUMAPPLY (lines 82-102):</p> <pre><code>site_key = [\n    batch: meta.batch,\n    plate: meta.plate,\n    well: meta.well,\n    site: meta.site,\n    arm: meta.arm,\n    id: \"${meta.batch}_${meta.plate}_${meta.well}_Site${meta.site}\"\n]\n// Groups by individual site\n</code></pre>"},{"location":"load_data_csv_generation/#current-approach-analysis","title":"Current Approach Analysis","text":""},{"location":"load_data_csv_generation/#advantages","title":"Advantages","text":"<ol> <li>Flexible: Can work with or without explicit metadata CLI args</li> <li>Resilient: Falls back to filename parsing when metadata not provided</li> <li>Traceable: Metadata flows from samplesheet through channels</li> <li>Modular: Separate scripts for different use cases</li> </ol>"},{"location":"load_data_csv_generation/#inconsistencies","title":"Inconsistencies","text":"<ol> <li>Mixed Approach: Some processes pass metadata as args, others parse from filenames</li> <li>Redundancy: Well and Site parsed from filenames even when available in <code>meta</code> map</li> <li>Coupling: Plate name must match between samplesheet and filenames for combined analysis</li> <li>Two Scripts: Separate scripts for standard vs combined analysis</li> </ol>"},{"location":"load_data_csv_generation/#potential-refactoring-goals","title":"Potential Refactoring Goals","text":"<ol> <li>Standardize on single approach (prefer metadata-driven)</li> <li>Pass all available metadata from <code>meta</code> map to scripts</li> <li>Use filename parsing only as fallback validation</li> <li>Consolidate scripts if possible</li> <li>Ensure consistent filename generation across all processes</li> <li>Add validation that samplesheet metadata matches filename-parsed metadata</li> </ol>"},{"location":"load_data_csv_generation/#key-code-locations","title":"Key Code Locations","text":"Component File Lines Description Samplesheet Entry <code>main.nf</code> 69 Parse input CSV Schema Validation <code>assets/schema_input.json</code> - Define required columns Main Script <code>bin/generate_load_data_csv.py</code> - General CSV generation Combined Script <code>bin/generate_combined_load_data.py</code> - Combined analysis CSV ILLUMCALC Module <code>modules/local/cellprofiler/illumcalc/main.nf</code> 28-36 Pass plate from meta ILLUMAPPLY Module <code>modules/local/cellprofiler/illumapply/main.nf</code> 28-36 Pass plate+cycles from meta PREPROCESS Module <code>modules/local/cellprofiler/preprocess/main.nf</code> 30-33 No metadata args COMBINEDANALYSIS Module <code>modules/local/cellprofiler/combinedanalysis/main.nf</code> 34-36 No metadata args Cellpainting Subworkflow <code>subworkflows/local/cellpainting/main.nf</code> 30-101 Channel grouping logic Barcoding Subworkflow <code>subworkflows/local/barcoding/main.nf</code> 30-102 Channel grouping logic"},{"location":"load_data_csv_generation/#testing-reference","title":"Testing Reference","text":"<p>Test File: <code>modules/local/cellprofiler/preprocess/tests/main.nf.test</code> Snapshot: <code>modules/local/cellprofiler/preprocess/tests/main.nf.test.snap</code></p> <p>Example Test Metadata:</p> <pre><code>meta = [\n    id: \"Batch1_Plate1_barcoding_A1\",\n    batch: \"Batch1\",\n    plate: \"Plate1\",\n    well: \"A1\",\n    arm: \"barcoding\"\n]\n</code></pre> <p>Expected Output Filename:</p> <pre><code>Plate_Plate1_Well_A1_Site0_Cycle01_A.tiff\n</code></pre> <p>This confirms metadata flows: Samplesheet \u2192 meta map \u2192 output filenames \u2192 CSV parsing</p>"},{"location":"developer/architecture/","title":"Architecture","text":"<p>Technical overview of the pipeline architecture and implementation.</p>"},{"location":"developer/architecture/#pipeline-structure","title":"Pipeline Structure","text":"<pre><code>nf-pooled-cellpainting/\n\u251c\u2500\u2500 main.nf                          # Entry point\n\u251c\u2500\u2500 nextflow.config                  # Main configuration\n\u251c\u2500\u2500 workflows/\n\u2502   \u2514\u2500\u2500 nf-pooled-cellpainting.nf   # Main workflow logic\n\u251c\u2500\u2500 subworkflows/\n\u2502   \u2514\u2500\u2500 local/\n\u2502       \u251c\u2500\u2500 cellpainting/           # Cell painting processing arm\n\u2502       \u251c\u2500\u2500 barcoding/              # Barcoding processing arm\n\u2502       \u2514\u2500\u2500 utils*/                 # Utility subworkflows\n\u251c\u2500\u2500 modules/\n\u2502   \u251c\u2500\u2500 local/\n\u2502   \u2502   \u251c\u2500\u2500 cellprofiler/          # CellProfiler processes\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 illumcalc/         # Illumination calculation\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 illumapply/        # Illumination application\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 preprocess/        # Barcode preprocessing\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 segcheck/          # Segmentation QC\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 combinedanalysis/  # Combined analysis\n\u2502   \u2502   \u251c\u2500\u2500 fiji/                  # Fiji image processing\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 stitchcrop/        # Image stitching &amp; cropping\n\u2502   \u2502   \u2514\u2500\u2500 qc/                    # QC processes\n\u2502   \u2514\u2500\u2500 nf-core/                   # nf-core modules (MultiQC)\n\u251c\u2500\u2500 bin/                            # Python scripts &amp; tools\n\u251c\u2500\u2500 conf/                           # Configuration files\n\u251c\u2500\u2500 assets/                         # CellProfiler pipelines &amp; resources\n\u251c\u2500\u2500 lib/                            # Groovy library functions\n\u251c\u2500\u2500 docs/                           # Documentation source\n\u2514\u2500\u2500 tests/                          # nf-test test cases\n</code></pre>"},{"location":"developer/architecture/#workflow-design","title":"Workflow Design","text":""},{"location":"developer/architecture/#main-workflow","title":"Main Workflow","text":"<p>The main workflow (<code>workflows/nf-pooled-cellpainting.nf</code>) orchestrates two parallel processing arms:</p> <pre><code>workflow NF_POOLED_CELLPAINTING {\n    // Split samplesheet into painting and barcoding arms\n    ch_samplesheet\n        .branch { meta, files -&gt;\n            painting: meta.arm == 'painting'\n            barcoding: meta.arm == 'barcoding'\n        }\n        .set { ch_branched }\n\n    // Process painting arm\n    CELLPAINTING(ch_branched.painting, ...)\n\n    // Process barcoding arm\n    BARCODING(ch_branched.barcoding, ...)\n\n    // Combined analysis (conditional)\n    if (qc_painting_passed &amp;&amp; qc_barcoding_passed) {\n        CELLPROFILER_COMBINEDANALYSIS(\n            CELLPAINTING.out.stitched_cropped,\n            BARCODING.out.stitched_cropped,\n            ...\n        )\n    }\n}\n</code></pre>"},{"location":"developer/architecture/#cell-painting-subworkflow","title":"Cell Painting Subworkflow","text":"<p>Located in <code>subworkflows/local/cellpainting/main.nf</code>:</p> <ol> <li>ILLUMCALC: Calculate illumination corrections</li> <li>Groups by: <code>[batch, plate]</code></li> <li>Outputs: <code>.npy</code> illumination functions per plate</li> <li>QC_MONTAGEILLUM: Generate illumination QC montages</li> <li>ILLUMAPPLY: Apply illumination corrections</li> <li>Groups by: <code>[batch, plate, well, site]</code></li> <li>Parallelized per site</li> <li>SEGCHECK: Segmentation quality check</li> <li>Subsampled by <code>range_skip</code> parameter</li> <li>QC_MONTAGE_SEGCHECK: Segmentation QC visualizations</li> <li>FIJI_STITCHCROP: Stitch and crop images (conditional)</li> <li>Groups by: <code>[batch, plate, well]</code></li> <li>Enabled when <code>qc_painting_passed == true</code></li> <li>QC_MONTAGE_STITCHCROP: Stitching QC visualizations</li> </ol>"},{"location":"developer/architecture/#barcoding-subworkflow","title":"Barcoding Subworkflow","text":"<p>Located in <code>subworkflows/local/barcoding/main.nf</code>:</p> <ol> <li>ILLUMCALC: Calculate cycle-specific illumination corrections</li> <li>Groups by: <code>[batch, plate, cycle]</code></li> <li>QC_MONTAGEILLUM: Illumination QC montages</li> <li>ILLUMAPPLY: Apply illumination corrections</li> <li>Groups by: <code>[batch, plate, well, site]</code></li> <li>Parallelized per site</li> <li>QC_BARCODEALIGN: Barcode alignment QC</li> <li>Checks pixel shifts and correlation between cycles</li> <li>Validates against <code>barcoding_shift_threshold</code> and <code>barcoding_corr_threshold</code></li> <li>PREPROCESS: Barcode calling and preprocessing</li> <li>Uses CellProfiler plugins (<code>callbarcodes</code>, <code>compensatecolors</code>)</li> <li>QC_PREPROCESS: Preprocessing QC visualizations</li> <li>FIJI_STITCHCROP: Stitch and crop (conditional)</li> <li>Enabled when <code>qc_barcoding_passed == true</code></li> </ol>"},{"location":"developer/architecture/#channel-architecture","title":"Channel Architecture","text":""},{"location":"developer/architecture/#data-flow","title":"Data Flow","text":"<p>Nextflow channels carry metadata and file references:</p> <pre><code>[meta, files]\n</code></pre> <p>Where <code>meta</code> contains:</p> <pre><code>meta = [\n    batch: 'batch1',\n    plate: 'P001',\n    well: 'A01',\n    site: 1,\n    cycle: 1,          // barcoding only\n    channels: ['DAPI', 'GFP', 'RFP'],\n    n_frames: 4,\n    arm: 'painting'\n]\n</code></pre>"},{"location":"developer/architecture/#grouping-strategy","title":"Grouping Strategy","text":"<p>Processes group inputs at optimal granularity:</p> <pre><code>// Illumination calculation: per plate\nch_input\n    .map { meta, files -&gt;\n        def key = [meta.batch, meta.plate]\n        [key, meta, files]\n    }\n    .groupTuple(by: 0)\n\n// Illumination correction: per well\nch_input\n    .map { meta, files -&gt;\n        def key = [meta.batch, meta.plate, meta.well]\n        [key, meta, files]\n    }\n    .groupTuple(by: 0)\n</code></pre>"},{"location":"developer/architecture/#parallelization","title":"Parallelization","text":"<p>The pipeline implements fine-grained parallelization:</p> <ul> <li>Illumination calculation: Grouped by plate (or plate+cycle for barcoding)</li> <li>Illumination correction: Parallelized per site</li> <li>Stitching: Parallelized per well</li> <li>Combined analysis: Parallelized per site</li> <li>Result: Optimal resource utilization and throughput</li> </ul>"},{"location":"developer/architecture/#process-design","title":"Process Design","text":""},{"location":"developer/architecture/#standard-process-structure","title":"Standard Process Structure","text":"<pre><code>process EXAMPLE_PROCESS {\n    tag \"${meta.batch}_${meta.plate}_${meta.well}\"\n    label 'process_medium'\n    container 'wave.seqera.io/cellprofiler/cellprofiler:4.2.8'\n\n    input:\n    tuple val(meta), path(images)\n    path(cppipe)\n\n    output:\n    tuple val(meta), path(\"output/*\"), emit: images\n    path(\"*.csv\"), emit: csv\n\n    script:\n    \"\"\"\n    # Generate load_data.csv\n    generate_load_data_csv.py \\\\\n        --pipeline_type example \\\\\n        --output load_data.csv\n\n    # Run CellProfiler\n    cellprofiler \\\\\n        -c -r \\\\\n        -p ${cppipe} \\\\\n        -o output/ \\\\\n        --data-file=load_data.csv\n    \"\"\"\n}\n</code></pre>"},{"location":"developer/architecture/#key-conventions","title":"Key Conventions","text":"<ol> <li>Tagging: Use metadata for process identification</li> <li>Labels: Apply resource labels (<code>process_low</code>, <code>process_medium</code>, <code>process_high</code>)</li> <li>Containers: Specify container images explicitly</li> <li>Output channels: Name channels with <code>emit:</code></li> <li>Scripts: Use Python helpers for CSV generation</li> </ol>"},{"location":"developer/architecture/#qc-gate-implementation","title":"QC Gate Implementation","text":""},{"location":"developer/architecture/#conditional-execution","title":"Conditional Execution","text":"<p>QC gates control progression:</p> <pre><code>if (params.qc_painting_passed) {\n    FIJI_STITCHCROP(\n        CELLPROFILER_ILLUMAPPLY.out.corrected,\n        ...\n    )\n}\n</code></pre>"},{"location":"developer/architecture/#manual-review-workflow","title":"Manual Review Workflow","text":"<ol> <li>Run pipeline with default QC parameters (<code>false</code>)</li> <li>Pipeline stops after initial QC checks</li> <li>Review QC outputs in <code>results/qc/</code></li> <li>Re-run with <code>--qc_painting_passed true</code> if QC passes</li> <li>Pipeline resumes from cached results (<code>-resume</code>)</li> </ol>"},{"location":"developer/architecture/#data-staging","title":"Data Staging","text":""},{"location":"developer/architecture/#load-data-csv-generation","title":"Load Data CSV Generation","text":"<p>All CellProfiler processes require <code>load_data.csv</code> files:</p> <pre><code>generate_load_data_csv.py \\\n    --pipeline_type illumcalc \\\n    --channels DAPI,GFP,RFP \\\n    --output load_data.csv\n</code></pre> <p>Supported pipeline types:</p> <ul> <li><code>illumcalc</code>: Multi-channel raw images</li> <li><code>illumapply</code>: Corrected images + illumination functions</li> <li><code>segcheck</code>: Corrected images for QC</li> <li><code>preprocess</code>: Cycle-based barcoding images</li> <li><code>combined</code>: Painting + barcoding merged images</li> </ul>"},{"location":"developer/architecture/#file-organization","title":"File Organization","text":"<p>Output files follow consistent naming:</p> <pre><code># Painting corrected images\nPlate_{plate}_Well_{well}_Site_{site}_Corr{channel}.tiff\n\n# Barcoding corrected images\nPlate_{plate}_Well_{well}_Site_{site}_Cycle{cycle}_{channel}.tiff\n\n# Stitched/cropped images\nPlate_{plate}_Well_{well}_Site_{site}_*.tiff\n\n# Illumination functions\n{plate}_Illum{channel}.npy\n</code></pre>"},{"location":"developer/architecture/#plugin-integration","title":"Plugin Integration","text":""},{"location":"developer/architecture/#cellprofiler-plugins","title":"CellProfiler Plugins","text":"<p>Plugins are downloaded and staged before CellProfiler execution:</p> <pre><code>script:\n\"\"\"\n# Download plugins\nwget -O callbarcodes.py ${params.callbarcodes_plugin}\nwget -O compensatecolors.py ${params.compensatecolors_plugin}\n\n# Run CellProfiler with plugin directory\ncellprofiler \\\\\n    -c -r \\\\\n    -p ${cppipe} \\\\\n    --plugins-directory=.\n\"\"\"\n</code></pre>"},{"location":"developer/architecture/#plugin-requirements","title":"Plugin Requirements","text":"<ul> <li><code>callbarcodes.py</code>: Barcode calling logic</li> <li><code>compensatecolors.py</code>: Color compensation for barcoding</li> </ul>"},{"location":"developer/architecture/#error-handling","title":"Error Handling","text":""},{"location":"developer/architecture/#retry-strategy","title":"Retry Strategy","text":"<pre><code>process {\n    errorStrategy = 'retry'\n    maxRetries = 3\n\n    withLabel: 'process_high' {\n        memory = { task.attempt == 1 ? 32.GB : 64.GB }\n    }\n}\n</code></pre>"},{"location":"developer/architecture/#debugging","title":"Debugging","text":"<p>Enable trace and debugging:</p> <pre><code>nextflow run main.nf -with-trace -with-dag dag.png\n</code></pre>"},{"location":"developer/architecture/#performance-considerations","title":"Performance Considerations","text":""},{"location":"developer/architecture/#resource-allocation","title":"Resource Allocation","text":"<p>Optimize based on process characteristics:</p> <ul> <li>ILLUMCALC: High memory (processes all images per plate)</li> <li>ILLUMAPPLY: Medium resources (processes per well)</li> <li>PREPROCESS: Medium resources with plugin overhead</li> <li>STITCHCROP: Medium CPU for Fiji operations</li> </ul>"},{"location":"developer/architecture/#caching-strategy","title":"Caching Strategy","text":"<p>Nextflow caches completed tasks. Key factors:</p> <ul> <li>Input files (content-based hashing)</li> <li>Script changes</li> <li>Container changes</li> <li>Parameter changes</li> </ul> <p>Use <code>-resume</code> to leverage caching after failures or parameter tweaks.</p>"},{"location":"developer/architecture/#next-steps","title":"Next Steps","text":"<ul> <li>CellProfiler Integration - Deep dive into CellProfiler usage</li> <li>Python Scripts - Understand data staging scripts</li> <li>Testing - Learn testing strategies</li> </ul>"},{"location":"developer/cellprofiler/","title":"CellProfiler Integration","text":"<p>Deep dive into how CellProfiler is integrated and executed within the pipeline.</p>"},{"location":"developer/cellprofiler/#overview","title":"Overview","text":"<p>The pipeline uses CellProfiler v4.2.8 for image analysis tasks:</p> <ul> <li>Illumination correction calculation and application</li> <li>Image preprocessing</li> <li>Cell segmentation</li> <li>Feature extraction</li> <li>Barcode calling</li> </ul>"},{"location":"developer/cellprofiler/#cellprofiler-processes","title":"CellProfiler Processes","text":""},{"location":"developer/cellprofiler/#process-modules","title":"Process Modules","text":"<p>All CellProfiler processes follow a similar pattern:</p> <pre><code>process CELLPROFILER_ILLUMCALC {\n    container 'wave.seqera.io/cellprofiler/cellprofiler:4.2.8'\n\n    input:\n    tuple val(meta), path(images)\n    path(cppipe)\n\n    script:\n    \"\"\"\n    # Generate load_data.csv\n    generate_load_data_csv.py \\\\\n        --pipeline_type illumcalc \\\\\n        --channels ${meta.channels.join(',')} \\\\\n        --output load_data.csv\n\n    # Run CellProfiler\n    cellprofiler \\\\\n        -c -r \\\\\n        -p ${cppipe} \\\\\n        -o . \\\\\n        --data-file=load_data.csv\n    \"\"\"\n}\n</code></pre>"},{"location":"developer/cellprofiler/#key-processes","title":"Key Processes","text":"Process Purpose Grouping Key Outputs <code>ILLUMCALC</code> Calculate illumination functions Per plate (or plate+cycle) <code>.npy</code> files <code>ILLUMAPPLY</code> Apply corrections Per well or site Corrected TIFF images <code>SEGCHECK</code> Segmentation QC Per well (subsampled) PNG previews, CSV stats <code>PREPROCESS</code> Barcode calling Per site Preprocessed TIFF, CSV <code>COMBINEDANALYSIS</code> Final segmentation Per site Masks, overlays, CSV"},{"location":"developer/cellprofiler/#pipeline-files-cppipe","title":"Pipeline Files (.cppipe)","text":""},{"location":"developer/cellprofiler/#structure","title":"Structure","text":"<p>CellProfiler pipelines are XML-based <code>.cppipe</code> files defining:</p> <ul> <li>Input modules (LoadData, LoadImages)</li> <li>Processing modules (CorrectIlluminationCalculate, ApplyIllumination)</li> <li>Output modules (SaveImages, ExportToSpreadsheet)</li> </ul>"},{"location":"developer/cellprofiler/#template-support","title":"Template Support","text":"<p>Pipelines can use template variables:</p> <pre><code>&lt;LoadData&gt;\n    &lt;csv_file_name&gt;load_data.csv&lt;/csv_file_name&gt;\n&lt;/LoadData&gt;\n</code></pre> <p>The pipeline automatically populates:</p> <ul> <li>Channel names</li> <li>File paths</li> <li>Output directories</li> </ul>"},{"location":"developer/cellprofiler/#example-pipelines","title":"Example Pipelines","text":"<p>The pipeline requires these <code>.cppipe</code> files:</p> <ol> <li>painting_illumcalc.cppipe: Calculate painting illumination</li> <li>Inputs: Multi-channel raw images</li> <li> <p>Outputs: <code>.npy</code> illumination functions per channel</p> </li> <li> <p>painting_illumapply.cppipe: Apply painting illumination</p> </li> <li>Inputs: Raw images + illumination functions</li> <li> <p>Outputs: Corrected TIFF images</p> </li> <li> <p>painting_segcheck.cppipe: Segmentation QC</p> </li> <li>Inputs: Corrected images</li> <li> <p>Outputs: Segmentation previews</p> </li> <li> <p>barcoding_illumcalc.cppipe: Calculate barcoding illumination</p> </li> <li>Inputs: Multi-cycle raw images</li> <li> <p>Outputs: Cycle-specific illumination functions</p> </li> <li> <p>barcoding_illumapply.cppipe: Apply barcoding illumination</p> </li> <li>Inputs: Raw cycle images + illumination functions</li> <li> <p>Outputs: Corrected cycle images</p> </li> <li> <p>barcoding_preprocess.cppipe: Barcode calling</p> </li> <li>Inputs: Corrected cycle images</li> <li>Outputs: Barcode-called images</li> <li> <p>Requires: <code>callbarcodes</code> and <code>compensatecolors</code> plugins</p> </li> <li> <p>combinedanalysis.cppipe: Final analysis</p> </li> <li>Inputs: Painting corrected + barcoding preprocessed images</li> <li>Outputs: Segmentation masks, feature measurements</li> <li>Requires: <code>callbarcodes</code> plugin</li> </ol>"},{"location":"developer/cellprofiler/#load-data-csv-generation","title":"Load Data CSV Generation","text":""},{"location":"developer/cellprofiler/#purpose","title":"Purpose","text":"<p>CellProfiler requires <code>load_data.csv</code> files that specify:</p> <ul> <li>Image file paths</li> <li>Metadata (plate, well, site, frame, channel, cycle)</li> <li>Image grouping for processing</li> </ul>"},{"location":"developer/cellprofiler/#generation-script","title":"Generation Script","text":"<p>The <code>generate_load_data_csv.py</code> script creates these files:</p> <pre><code>generate_load_data_csv.py \\\n    --pipeline_type illumcalc \\\n    --channels DAPI,GFP,RFP,Cy5,Cy3 \\\n    --frames 0,1,2,3 \\\n    --output load_data.csv\n</code></pre>"},{"location":"developer/cellprofiler/#pipeline-types","title":"Pipeline Types","text":"<p>Different CellProfiler stages require different CSV formats:</p>"},{"location":"developer/cellprofiler/#1-illumcalc-illumination-calculation","title":"1. <code>illumcalc</code> - Illumination Calculation","text":"<pre><code>Metadata_Plate,Metadata_Well,Metadata_Site,Metadata_Frame,FileName_DAPI,PathName_DAPI,...\nP001,A01,1,0,P001_A01_1_0_DAPI.tif,/path/to/images,...\n</code></pre>"},{"location":"developer/cellprofiler/#2-illumapply-illumination-correction","title":"2. <code>illumapply</code> - Illumination Correction","text":"<pre><code>Metadata_Plate,Metadata_Well,Metadata_Site,Metadata_Frame,FileName_OrigDAPI,PathName_OrigDAPI,FileName_IllumDAPI,PathName_IllumDAPI,...\nP001,A01,1,0,P001_A01_1_0_DAPI.tif,/orig/,P001_IllumDAPI.npy,/illum/,...\n</code></pre>"},{"location":"developer/cellprofiler/#3-preprocess-barcoding-with-cycles","title":"3. <code>preprocess</code> - Barcoding with Cycles","text":"<pre><code>Metadata_Plate,Metadata_Well,Metadata_Site,Metadata_Frame,Metadata_Cycle,FileName_Cycle1_Cy3,PathName_Cycle1_Cy3,...\nP001,A01,1,0,1,P001_A01_1_0_Cycle1_Cy3.tif,/path/,...\n</code></pre>"},{"location":"developer/cellprofiler/#4-combined-painting-barcoding","title":"4. <code>combined</code> - Painting + Barcoding","text":"<pre><code>Metadata_Plate,Metadata_Well,Metadata_Site,Metadata_Frame,FileName_CorrDAPI,PathName_CorrDAPI,FileName_Cycle1_Cy3,PathName_Cycle1_Cy3,...\nP001,A01,1,0,P001_A01_1_CorrDAPI.tif,/painting/,P001_A01_1_0_Cycle1_Cy3.tif,/barcoding/,...\n</code></pre>"},{"location":"developer/cellprofiler/#execution-details","title":"Execution Details","text":""},{"location":"developer/cellprofiler/#command-line-invocation","title":"Command-Line Invocation","text":"<p>CellProfiler is run in headless mode:</p> <pre><code>cellprofiler \\\n    -c \\                    # Run without GUI\n    -r \\                    # Run pipeline\n    -p pipeline.cppipe \\    # Pipeline file\n    -o output_dir/ \\        # Output directory\n    --data-file=load_data.csv  # Input CSV\n</code></pre>"},{"location":"developer/cellprofiler/#plugin-loading","title":"Plugin Loading","text":"<p>For processes requiring plugins:</p> <pre><code># Download plugins\nwget -O callbarcodes.py ${PLUGIN_URL}\nwget -O compensatecolors.py ${PLUGIN_URL}\n\n# Run with plugin directory\ncellprofiler \\\n    -c -r \\\n    -p pipeline.cppipe \\\n    --plugins-directory=. \\\n    --data-file=load_data.csv\n</code></pre>"},{"location":"developer/cellprofiler/#resource-requirements","title":"Resource Requirements","text":"<p>Typical resource allocation:</p> <pre><code>process {\n    withName: 'CELLPROFILER_ILLUMCALC' {\n        cpus = 8\n        memory = 32.GB\n        time = 8.h\n    }\n\n    withName: 'CELLPROFILER_ILLUMAPPLY' {\n        cpus = 4\n        memory = 16.GB\n        time = 4.h\n    }\n\n    withName: 'CELLPROFILER_PREPROCESS' {\n        cpus = 4\n        memory = 16.GB\n        time = 4.h\n    }\n}\n</code></pre>"},{"location":"developer/cellprofiler/#plugin-architecture","title":"Plugin Architecture","text":""},{"location":"developer/cellprofiler/#callbarcodes-plugin","title":"callbarcodes Plugin","text":"<p>Implements barcode calling logic:</p> <ul> <li>Reads multi-cycle fluorescence images</li> <li>Identifies brightest channel per cycle</li> <li>Constructs barcode sequences</li> <li>Assigns barcodes to cells</li> </ul> <p>Usage in pipeline:</p> <pre><code>&lt;RunCellpose&gt;\n    &lt;plugin_name&gt;callbarcodes&lt;/plugin_name&gt;\n    &lt;!-- Plugin-specific parameters --&gt;\n&lt;/RunCellpose&gt;\n</code></pre>"},{"location":"developer/cellprofiler/#compensatecolors-plugin","title":"compensatecolors Plugin","text":"<p>Performs spectral unmixing:</p> <ul> <li>Corrects fluorescence bleed-through between channels</li> <li>Improves barcode calling accuracy</li> </ul>"},{"location":"developer/cellprofiler/#output-organization","title":"Output Organization","text":""},{"location":"developer/cellprofiler/#file-naming-conventions","title":"File Naming Conventions","text":"<p>CellProfiler outputs follow structured naming:</p> <pre><code># Corrected images\n{plate}_{well}_{site}_Corr{channel}.tif\n\n# Illumination functions\n{plate}_Illum{channel}.npy\n\n# Preprocessed barcoding\n{plate}_{well}_{site}_Cycle{cycle}_{channel}.tif\n\n# Segmentation masks\n{plate}_{well}_{site}_Nuclei.tif\n{plate}_{well}_{site}_Cells.tif\n</code></pre>"},{"location":"developer/cellprofiler/#csv-outputs","title":"CSV Outputs","text":"<p>Feature measurements are saved as CSV:</p> <ul> <li><code>Image.csv</code>: Per-image measurements</li> <li><code>Nuclei.csv</code>: Per-nucleus measurements</li> <li><code>Cells.csv</code>: Per-cell measurements</li> <li><code>Experiment.csv</code>: Pipeline metadata</li> </ul>"},{"location":"developer/cellprofiler/#troubleshooting","title":"Troubleshooting","text":""},{"location":"developer/cellprofiler/#common-issues","title":"Common Issues","text":""},{"location":"developer/cellprofiler/#1-load-data-csv-errors","title":"1. Load Data CSV Errors","text":"<p>Symptom: CellProfiler fails with \"Unable to load image\"</p> <p>Solution: Validate CSV paths are accessible:</p> <pre><code># Check CSV format\nhead load_data.csv\n\n# Verify image paths exist\ncat load_data.csv | cut -d',' -f5 | xargs -I {} test -f {} &amp;&amp; echo \"OK\"\n</code></pre>"},{"location":"developer/cellprofiler/#2-plugin-not-found","title":"2. Plugin Not Found","text":"<p>Symptom: \"Plugin 'callbarcodes' not found\"</p> <p>Solution: Ensure plugin URL is accessible:</p> <pre><code>wget -O callbarcodes.py ${PLUGIN_URL}\ncellprofiler --plugins-directory=.\n</code></pre>"},{"location":"developer/cellprofiler/#3-memory-errors","title":"3. Memory Errors","text":"<p>Symptom: CellProfiler crashes with out-of-memory</p> <p>Solution: Increase process memory or reduce image size:</p> <pre><code>process {\n    withName: 'CELLPROFILER_.*' {\n        memory = { task.attempt == 1 ? 32.GB : 64.GB }\n        errorStrategy = 'retry'\n    }\n}\n</code></pre>"},{"location":"developer/cellprofiler/#debugging","title":"Debugging","text":"<p>Enable CellProfiler debugging:</p> <pre><code>cellprofiler \\\n    -c -r \\\n    -p pipeline.cppipe \\\n    --log-level=DEBUG \\\n    --data-file=load_data.csv\n</code></pre>"},{"location":"developer/cellprofiler/#best-practices","title":"Best Practices","text":"<ol> <li>Validate pipelines: Test <code>.cppipe</code> files in CellProfiler GUI first</li> <li>Template metadata: Use template variables for flexibility</li> <li>Resource tuning: Profile memory usage and adjust allocation</li> <li>Plugin versioning: Pin plugin versions for reproducibility</li> <li>Output validation: Check output file counts match expectations</li> </ol>"},{"location":"developer/cellprofiler/#next-steps","title":"Next Steps","text":"<ul> <li>Python Scripts - Understand CSV generation</li> <li>Architecture - Overall pipeline design</li> <li>Testing - Test CellProfiler integration</li> </ul>"},{"location":"developer/python-scripts/","title":"Python Scripts","text":"<p>Documentation of Python scripts used for data staging and quality control.</p>"},{"location":"developer/python-scripts/#overview","title":"Overview","text":"<p>The pipeline includes several Python scripts in the <code>bin/</code> directory:</p> <ul> <li><code>generate_load_data_csv.py</code>: Universal CSV generator for CellProfiler</li> <li><code>generate_combined_load_data.py</code>: Specialized CSV for combined analysis</li> <li><code>qc_barcode_align.py</code>: Barcode alignment quality control</li> </ul> <p>These scripts are automatically available in the process <code>PATH</code> and are called during pipeline execution.</p>"},{"location":"developer/python-scripts/#generate_load_data_csvpy","title":"generate_load_data_csv.py","text":""},{"location":"developer/python-scripts/#purpose","title":"Purpose","text":"<p>Generates <code>load_data.csv</code> files required by CellProfiler processes. This is the primary data staging script used throughout the pipeline.</p>"},{"location":"developer/python-scripts/#usage","title":"Usage","text":"<pre><code>generate_load_data_csv.py \\\n    --pipeline_type &lt;type&gt; \\\n    --channels &lt;channel_list&gt; \\\n    --frames &lt;frame_list&gt; \\\n    --cycles &lt;cycle_list&gt; \\\n    --output load_data.csv\n</code></pre>"},{"location":"developer/python-scripts/#parameters","title":"Parameters","text":"Parameter Required Description <code>--pipeline_type</code> Yes Pipeline stage: <code>illumcalc</code>, <code>illumapply</code>, <code>segcheck</code>, <code>analysis</code>, <code>preprocess</code>, <code>combined</code> <code>--channels</code> Yes Comma-separated channel names (e.g., <code>DAPI,GFP,RFP</code>) <code>--frames</code> No Comma-separated frame indices (e.g., <code>0,1,2,3</code>) <code>--cycles</code> No Comma-separated cycle numbers (e.g., <code>1,2,3</code>) - barcoding only <code>--output</code> Yes Output CSV file path"},{"location":"developer/python-scripts/#pipeline-types","title":"Pipeline Types","text":""},{"location":"developer/python-scripts/#1-illumcalc-illumination-calculation","title":"1. <code>illumcalc</code> - Illumination Calculation","text":"<p>Stages original multi-channel images for illumination function calculation.</p> <p>Output columns:</p> <pre><code>Metadata_Plate, Metadata_Well, Metadata_Site, Metadata_Frame,\nFileName_&lt;Channel&gt;, PathName_&lt;Channel&gt;\n</code></pre> <p>Example:</p> <pre><code>generate_load_data_csv.py \\\n    --pipeline_type illumcalc \\\n    --channels DAPI,GFP,RFP \\\n    --frames 0,1,2,3 \\\n    --output load_data.csv\n</code></pre>"},{"location":"developer/python-scripts/#2-illumapply-illumination-application","title":"2. <code>illumapply</code> - Illumination Application","text":"<p>Stages original images alongside illumination functions for correction.</p> <p>Output columns:</p> <pre><code>Metadata_Plate, Metadata_Well, Metadata_Site, Metadata_Frame,\nFileName_Orig&lt;Channel&gt;, PathName_Orig&lt;Channel&gt;,\nFileName_Illum&lt;Channel&gt;, PathName_Illum&lt;Channel&gt;\n</code></pre> <p>Example:</p> <pre><code>generate_load_data_csv.py \\\n    --pipeline_type illumapply \\\n    --channels DAPI,GFP,RFP \\\n    --frames 0,1,2,3 \\\n    --output load_data.csv\n</code></pre>"},{"location":"developer/python-scripts/#3-segcheck-segmentation-check","title":"3. <code>segcheck</code> - Segmentation Check","text":"<p>Stages corrected images for segmentation quality control.</p> <p>Output columns:</p> <pre><code>Metadata_Plate, Metadata_Well, Metadata_Site, Metadata_Frame,\nFileName_Corr&lt;Channel&gt;, PathName_Corr&lt;Channel&gt;\n</code></pre>"},{"location":"developer/python-scripts/#4-preprocess-barcoding-preprocessing","title":"4. <code>preprocess</code> - Barcoding Preprocessing","text":"<p>Stages cycle-based images for barcode calling.</p> <p>Output columns:</p> <pre><code>Metadata_Plate, Metadata_Well, Metadata_Site, Metadata_Frame, Metadata_Cycle,\nFileName_Cycle&lt;N&gt;_&lt;Channel&gt;, PathName_Cycle&lt;N&gt;_&lt;Channel&gt;\n</code></pre> <p>Example:</p> <pre><code>generate_load_data_csv.py \\\n    --pipeline_type preprocess \\\n    --channels Cy3,Cy5 \\\n    --cycles 1,2,3 \\\n    --frames 0,1,2,3 \\\n    --output load_data.csv\n</code></pre>"},{"location":"developer/python-scripts/#5-combined-combined-analysis","title":"5. <code>combined</code> - Combined Analysis","text":"<p>Stages both painting (corrected) and barcoding (preprocessed) images.</p> <p>Output columns:</p> <pre><code>Metadata_Plate, Metadata_Well, Metadata_Site, Metadata_Frame,\nFileName_Corr&lt;Channel&gt;, PathName_Corr&lt;Channel&gt;,\nFileName_Cycle&lt;N&gt;_&lt;Channel&gt;, PathName_Cycle&lt;N&gt;_&lt;Channel&gt;\n</code></pre>"},{"location":"developer/python-scripts/#implementation-details","title":"Implementation Details","text":"<p>The script:</p> <ol> <li>Scans directories for TIFF images matching expected patterns</li> <li>Parses filenames to extract metadata:</li> <li>Plate, well, site, frame</li> <li>Channel name</li> <li>Cycle (for barcoding)</li> <li>Groups images by metadata keys</li> <li>Generates CSV with proper CellProfiler column names</li> </ol>"},{"location":"developer/python-scripts/#filename-parsing","title":"Filename Parsing","text":"<p>Expected filename patterns:</p> <pre><code># Original images\n{plate}_{well}_{site}_{frame}_{channel}.tif\n\n# Corrected images\n{plate}_{well}_{site}_Corr{channel}.tif\n\n# Illumination functions\n{plate}_Illum{channel}.npy\n\n# Cycle images\n{plate}_{well}_{site}_{frame}_Cycle{cycle}_{channel}.tif\n</code></pre>"},{"location":"developer/python-scripts/#error-handling","title":"Error Handling","text":"<p>The script validates:</p> <ul> <li>File existence</li> <li>Metadata completeness</li> <li>Channel consistency</li> <li>Frame/cycle ranges</li> </ul>"},{"location":"developer/python-scripts/#generate_combined_load_datapy","title":"generate_combined_load_data.py","text":""},{"location":"developer/python-scripts/#purpose_1","title":"Purpose","text":"<p>Specialized script for combined analysis that merges painting and barcoding data.</p>"},{"location":"developer/python-scripts/#usage_1","title":"Usage","text":"<pre><code>generate_combined_load_data.py \\\n    --painting_dir /path/to/corrected/ \\\n    --barcoding_dir /path/to/preprocessed/ \\\n    --channels DAPI,GFP,RFP \\\n    --barcode_channels Cy3,Cy5 \\\n    --cycles 1,2,3 \\\n    --output combined_load_data.csv\n</code></pre>"},{"location":"developer/python-scripts/#key-features","title":"Key Features","text":"<ol> <li>Dual directory scanning: Reads from both painting and barcoding outputs</li> <li>Metadata alignment: Matches images by <code>(plate, well, site)</code></li> <li>Mixed column generation: Creates both <code>Corr</code> and <code>Cycle</code> columns</li> </ol>"},{"location":"developer/python-scripts/#output-format","title":"Output Format","text":"<pre><code>Metadata_Plate,Metadata_Well,Metadata_Site,Metadata_Frame,FileName_CorrDAPI,PathName_CorrDAPI,FileName_Cycle1_Cy3,PathName_Cycle1_Cy3,...\nP001,A01,1,0,P001_A01_1_CorrDAPI.tif,/painting/corrected/,P001_A01_1_0_Cycle1_Cy3.tif,/barcoding/preprocessed/,...\n</code></pre>"},{"location":"developer/python-scripts/#qc_barcode_alignpy","title":"qc_barcode_align.py","text":""},{"location":"developer/python-scripts/#purpose_2","title":"Purpose","text":"<p>Jupyter notebook for analyzing barcode alignment quality across cycles.</p>"},{"location":"developer/python-scripts/#functionality","title":"Functionality","text":"<ol> <li>Load cycle images: Reads corrected images from all cycles</li> <li>Calculate pixel shifts: Measures X/Y displacement between cycles</li> <li>Compute correlations: Calculates Pearson correlation between cycles</li> <li>Generate visualizations:</li> <li>Scatter plots of pixel shifts</li> <li>Correlation heatmaps</li> <li>Spatial shift maps</li> <li>Validate thresholds: Checks against <code>barcoding_shift_threshold</code> and <code>barcoding_corr_threshold</code></li> </ol>"},{"location":"developer/python-scripts/#usage_2","title":"Usage","text":"<pre><code># In Jupyter or as script\nqc_barcode_align.py \\\n    --input_dir /path/to/corrected/cycles/ \\\n    --shift_threshold 50 \\\n    --corr_threshold 0.9 \\\n    --output_dir qc/barcode_align/\n</code></pre>"},{"location":"developer/python-scripts/#output-files","title":"Output Files","text":"<ul> <li><code>shift_summary.csv</code>: Per-site shift statistics</li> <li><code>correlation_matrix.csv</code>: Cycle-to-cycle correlations</li> <li><code>shift_spatial_plot.png</code>: Spatial distribution of shifts</li> <li><code>correlation_heatmap.png</code>: Correlation visualization</li> <li><code>qc_report.html</code>: Interactive QC report</li> </ul>"},{"location":"developer/python-scripts/#qc-criteria","title":"QC Criteria","text":"<p>Pass criteria:</p> <ul> <li>Mean pixel shift &lt; <code>barcoding_shift_threshold</code></li> <li>Mean correlation &gt; <code>barcoding_corr_threshold</code></li> </ul> <p>Fail criteria:</p> <ul> <li>Any site exceeds shift threshold</li> <li>Any cycle pair below correlation threshold</li> </ul>"},{"location":"developer/python-scripts/#development-guide","title":"Development Guide","text":""},{"location":"developer/python-scripts/#adding-new-pipeline-types","title":"Adding New Pipeline Types","text":"<p>To support a new CellProfiler stage:</p> <ol> <li>Update <code>generate_load_data_csv.py</code>:</li> </ol> <pre><code>def generate_newtype_csv(images, channels, output):\n    rows = []\n    for img in images:\n        row = {\n            'Metadata_Plate': img.plate,\n            'Metadata_Well': img.well,\n            # ... additional metadata\n            f'FileName_{channel}': img.filename,\n            f'PathName_{channel}': img.path\n        }\n        rows.append(row)\n\n    df = pd.DataFrame(rows)\n    df.to_csv(output, index=False)\n</code></pre> <ol> <li>Add to pipeline type switch:</li> </ol> <pre><code>if pipeline_type == 'newtype':\n    generate_newtype_csv(images, channels, output)\n</code></pre> <ol> <li>Update process module:</li> </ol> <pre><code>script:\n\"\"\"\ngenerate_load_data_csv.py \\\n    --pipeline_type newtype \\\n    --channels ${meta.channels.join(',')} \\\n    --output load_data.csv\n\"\"\"\n</code></pre>"},{"location":"developer/python-scripts/#testing-scripts","title":"Testing Scripts","text":"<p>Test scripts in isolation:</p> <pre><code># Create test data\nmkdir -p test_images\ntouch test_images/P001_A01_1_0_DAPI.tif\ntouch test_images/P001_A01_1_0_GFP.tif\n\n# Run script\npython bin/generate_load_data_csv.py \\\n    --pipeline_type illumcalc \\\n    --channels DAPI,GFP \\\n    --frames 0 \\\n    --output test_load_data.csv\n\n# Validate output\nhead test_load_data.csv\n</code></pre>"},{"location":"developer/python-scripts/#debugging","title":"Debugging","text":"<p>Enable verbose logging:</p> <pre><code>import logging\nlogging.basicConfig(level=logging.DEBUG)\n</code></pre>"},{"location":"developer/python-scripts/#best-practices","title":"Best Practices","text":"<ol> <li>Validate inputs: Check file existence before processing</li> <li>Handle edge cases: Empty directories, missing frames, etc.</li> <li>Consistent naming: Follow established filename conventions</li> <li>Error messages: Provide clear, actionable error messages</li> <li>Logging: Log key operations for debugging</li> <li>Testing: Write unit tests for parsing logic</li> </ol>"},{"location":"developer/python-scripts/#common-issues","title":"Common Issues","text":""},{"location":"developer/python-scripts/#missing-images","title":"Missing Images","text":"<p>Symptom: CSV has fewer rows than expected</p> <p>Solution: Check filename patterns match exactly:</p> <pre><code>ls test_images/ | grep -E \"P[0-9]+_[A-Z][0-9]+_[0-9]+_[0-9]+_.*\\.tif\"\n</code></pre>"},{"location":"developer/python-scripts/#metadata-mismatches","title":"Metadata Mismatches","text":"<p>Symptom: CellProfiler can't group images properly</p> <p>Solution: Ensure metadata columns are populated correctly:</p> <pre><code>df[['Metadata_Plate', 'Metadata_Well', 'Metadata_Site']].drop_duplicates()\n</code></pre>"},{"location":"developer/python-scripts/#path-issues","title":"Path Issues","text":"<p>Symptom: CellProfiler can't find images</p> <p>Solution: Use absolute paths or ensure relative paths are correct:</p> <pre><code>PathName = os.path.abspath(image_dir)\n</code></pre>"},{"location":"developer/python-scripts/#next-steps","title":"Next Steps","text":"<ul> <li>Architecture - Understand where scripts are called</li> <li>CellProfiler Integration - How CSV files are used</li> <li>Testing - Test script integration</li> </ul>"},{"location":"getting-started/installation/","title":"Installation","text":""},{"location":"getting-started/installation/#prerequisites","title":"Prerequisites","text":""},{"location":"getting-started/installation/#required","title":"Required","text":"<ul> <li>Nextflow <code>&gt;= 23.04.0</code></li> <li>Java <code>&gt;= 11</code></li> <li>Container engine: One of:</li> <li>Docker</li> <li>Singularity/Apptainer</li> <li>Podman</li> <li>Shifter</li> <li>Charliecloud</li> </ul>"},{"location":"getting-started/installation/#optional","title":"Optional","text":"<ul> <li>Seqera Platform account for cloud/HPC execution</li> <li>Git for version control</li> </ul>"},{"location":"getting-started/installation/#install-nextflow","title":"Install Nextflow","text":"CondaManualVerify <pre><code>conda install -c bioconda nextflow\n</code></pre> <pre><code>curl -s https://get.nextflow.io | bash\nmv nextflow ~/bin/\n</code></pre> <pre><code>nextflow -version\n</code></pre>"},{"location":"getting-started/installation/#install-container-engine","title":"Install Container Engine","text":"DockerSingularityApptainer <p>Follow the official Docker installation guide.</p> <pre><code># On HPC systems, Singularity is often pre-installed\nsingularity --version\n</code></pre> <pre><code># Apptainer is the community fork of Singularity\napptainer --version\n</code></pre>"},{"location":"getting-started/installation/#get-the-pipeline","title":"Get the Pipeline","text":"From GitHubRun Directly <pre><code>git clone https://github.com/your-org/nf-pooled-cellpainting.git\ncd nf-pooled-cellpainting\n</code></pre> <p>Nextflow can pull from GitHub automatically:</p> <pre><code>nextflow run your-org/nf-pooled-cellpainting --input samplesheet.csv --outdir results\n</code></pre>"},{"location":"getting-started/installation/#prepare-input-files","title":"Prepare Input Files","text":""},{"location":"getting-started/installation/#1-samplesheet","title":"1. Samplesheet","text":"<p>Create a CSV with the following columns:</p> <pre><code>path,arm,batch,plate,well,channels,site,cycle,n_frames\n</code></pre> <p>Example:</p> <pre><code>/data/images/,painting,batch1,plate1,A01,DAPI-GFP-RFP,1,,4\n/data/images/,barcoding,batch1,plate1,A01,Cy3-Cy5,1,1,4\n</code></pre>"},{"location":"getting-started/installation/#2-barcodes-file","title":"2. Barcodes File","text":"<p>Create a CSV with barcode definitions:</p> <pre><code>barcode_id,sequence\n</code></pre>"},{"location":"getting-started/installation/#3-cellprofiler-pipelines","title":"3. CellProfiler Pipelines","text":"<p>Prepare <code>.cppipe</code> files for each stage:</p> <ul> <li>Painting illumination calculation</li> <li>Painting illumination correction</li> <li>Segmentation check</li> <li>Barcoding illumination calculation</li> <li>Barcoding illumination correction</li> <li>Barcoding preprocessing</li> <li>Combined analysis</li> </ul>"},{"location":"getting-started/installation/#4-cellprofiler-plugins","title":"4. CellProfiler Plugins","text":"<p>Download required plugins:</p> <ul> <li><code>callbarcodes.py</code>: Barcode calling logic</li> <li><code>compensatecolors.py</code>: Color compensation</li> </ul> <p>Store as URL-accessible files or local paths.</p>"},{"location":"getting-started/installation/#configuration","title":"Configuration","text":"<p>Create a <code>nextflow.config</code> or use command-line parameters:</p> <pre><code>params {\n    input = 'samplesheet.csv'\n    barcodes = 'barcodes.csv'\n    outdir = 'results'\n\n    // CellProfiler pipelines\n    painting_illumcalc_cppipe = 'pipelines/painting_illumcalc.cppipe'\n    painting_illumapply_cppipe = 'pipelines/painting_illumapply.cppipe'\n    // ... additional pipeline paths\n}\n</code></pre>"},{"location":"getting-started/installation/#test-the-installation","title":"Test the Installation","text":"<p>Run a minimal test:</p> <pre><code>nextflow run main.nf --help\n</code></pre> <p>You should see the pipeline help message with all available parameters.</p>"},{"location":"getting-started/installation/#next-steps","title":"Next Steps","text":"<ul> <li>Quick Start Guide - Run your first analysis</li> <li>Parameters Reference - Configure the pipeline</li> </ul>"},{"location":"getting-started/overview/","title":"Overview","text":""},{"location":"getting-started/overview/#what-is-nf-pooled-cellpainting","title":"What is nf-pooled-cellpainting?","text":"<p>nf-pooled-cellpainting is a Nextflow pipeline designed for optical pooled screening (OPS), a high-throughput technique that combines:</p> <ol> <li>Cell Painting: Multi-channel fluorescence microscopy for phenotypic profiling</li> <li>Barcoding: Sequencing-by-synthesis (SBS) for genetic identification</li> </ol> <p>This approach enables screening of thousands of genetic perturbations while maintaining single-cell resolution.</p>"},{"location":"getting-started/overview/#pipeline-workflow","title":"Pipeline Workflow","text":"<p>The pipeline consists of two parallel processing arms that converge for combined analysis:</p>"},{"location":"getting-started/overview/#cell-painting-arm","title":"Cell Painting Arm","text":"<pre><code>graph LR\n    A[Raw Images] --&gt; B[Illumination Calculation]\n    B --&gt; C[Illumination Correction]\n    C --&gt; D[Segmentation QC]\n    D --&gt; E{QC Pass?}\n    E --&gt;|Yes| F[Stitch &amp; Crop]\n    E --&gt;|No| G[Manual Review]\n</code></pre>"},{"location":"getting-started/overview/#barcoding-arm","title":"Barcoding Arm","text":"<pre><code>graph LR\n    A[Cycle Images] --&gt; B[Illumination Calculation]\n    B --&gt; C[Illumination Correction]\n    C --&gt; D[Alignment QC]\n    D --&gt; E[Preprocess &amp; Call Barcodes]\n    E --&gt; F{QC Pass?}\n    F --&gt;|Yes| G[Stitch &amp; Crop]\n    F --&gt;|No| H[Manual Review]\n</code></pre>"},{"location":"getting-started/overview/#combined-analysis","title":"Combined Analysis","text":"<p>When both arms pass QC, the pipeline merges the data for:</p> <ul> <li>Cell segmentation using painting channels</li> <li>Barcode assignment to segmented cells</li> <li>Feature extraction and measurements</li> <li>Comprehensive CSV outputs</li> </ul>"},{"location":"getting-started/overview/#key-concepts","title":"Key Concepts","text":""},{"location":"getting-started/overview/#quality-control-gates","title":"Quality Control Gates","text":"<p>The pipeline includes QC gates controlled by parameters:</p> <ul> <li><code>qc_painting_passed</code>: Enables progression past painting QC</li> <li><code>qc_barcoding_passed</code>: Enables progression past barcoding QC</li> </ul> <p>These gates allow manual review before committing to expensive downstream processing.</p>"},{"location":"getting-started/overview/#parallelization-strategy","title":"Parallelization Strategy","text":"<p>Processing is parallelized at optimal granularity:</p> <ul> <li>Illumination calculation: Per plate (or plate+cycle for barcoding)</li> <li>Illumination correction: Per site for both arms</li> <li>Stitching: Per well</li> <li>Combined analysis: Per site</li> </ul>"},{"location":"getting-started/overview/#data-organization","title":"Data Organization","text":"<p>Input data follows a structured samplesheet format with metadata for:</p> <ul> <li><code>batch</code>, <code>plate</code>, <code>well</code>, <code>site</code>: Spatial organization</li> <li><code>cycle</code>: Sequencing round (barcoding only)</li> <li><code>channels</code>: Fluorescence channels</li> <li><code>n_frames</code>: Number of tiles per site</li> </ul>"},{"location":"getting-started/overview/#technology-stack","title":"Technology Stack","text":"<ul> <li>Nextflow: Workflow orchestration and parallelization</li> <li>CellProfiler: Image analysis and feature extraction</li> <li>Fiji: Image stitching and montage generation</li> <li>Python: CSV generation and QC analysis</li> <li>Docker/Singularity: Containerized execution</li> </ul>"},{"location":"getting-started/overview/#next-steps","title":"Next Steps","text":"<ul> <li>Installation Guide - Set up the pipeline</li> <li>Quick Start - Run your first analysis</li> <li>Parameters Reference - Configure the pipeline</li> </ul>"},{"location":"getting-started/quickstart/","title":"Quick Start","text":"<p>This guide walks through running the pipeline with example data.</p>"},{"location":"getting-started/quickstart/#basic-execution","title":"Basic Execution","text":""},{"location":"getting-started/quickstart/#minimal-command","title":"Minimal Command","text":"<pre><code>nextflow run main.nf \\\n  --input samplesheet.csv \\\n  --barcodes barcodes.csv \\\n  --outdir results \\\n  --painting_illumcalc_cppipe pipelines/painting_illumcalc.cppipe \\\n  --painting_illumapply_cppipe pipelines/painting_illumapply.cppipe \\\n  --painting_segcheck_cppipe pipelines/painting_segcheck.cppipe \\\n  --barcoding_illumcalc_cppipe pipelines/barcoding_illumcalc.cppipe \\\n  --barcoding_illumapply_cppipe pipelines/barcoding_illumapply.cppipe \\\n  --barcoding_preprocess_cppipe pipelines/barcoding_preprocess.cppipe \\\n  --combinedanalysis_cppipe pipelines/combinedanalysis.cppipe \\\n  --callbarcodes_plugin 'https://example.com/callbarcodes.py' \\\n  --compensatecolors_plugin 'https://example.com/compensatecolors.py' \\\n  -profile docker\n</code></pre>"},{"location":"getting-started/quickstart/#with-resume","title":"With Resume","text":"<p>Nextflow caches completed tasks. Resume after interruption:</p> <pre><code>nextflow run main.nf --input samplesheet.csv ... -resume\n</code></pre>"},{"location":"getting-started/quickstart/#typical-workflow","title":"Typical Workflow","text":""},{"location":"getting-started/quickstart/#1-initial-qc-run","title":"1. Initial QC Run","text":"<p>Run without QC gates enabled (default):</p> <pre><code>nextflow run main.nf \\\n  --input samplesheet.csv \\\n  --barcodes barcodes.csv \\\n  --outdir results \\\n  [... pipeline paths ...] \\\n  -profile docker\n</code></pre> <p>This executes through illumination correction and QC checks but stops before stitching.</p>"},{"location":"getting-started/quickstart/#2-review-qc-outputs","title":"2. Review QC Outputs","text":"<p>Check the QC montages and statistics in the <code>results/</code> directory:</p> <ul> <li><code>qc/montage_illum/</code>: Illumination correction previews</li> <li><code>qc/montage_segcheck/</code>: Segmentation quality checks</li> <li><code>qc/barcode_align/</code>: Barcode alignment metrics</li> </ul>"},{"location":"getting-started/quickstart/#3-enable-qc-gates","title":"3. Enable QC Gates","text":"<p>After manual review, enable progression:</p> <pre><code>nextflow run main.nf \\\n  --input samplesheet.csv \\\n  --barcodes barcodes.csv \\\n  --outdir results \\\n  [... pipeline paths ...] \\\n  --qc_painting_passed true \\\n  --qc_barcoding_passed true \\\n  -profile docker \\\n  -resume\n</code></pre> <p>This continues from where it stopped and runs:</p> <ul> <li>Image stitching and cropping</li> <li>Combined analysis</li> <li>Final outputs</li> </ul>"},{"location":"getting-started/quickstart/#example-samplesheet","title":"Example Samplesheet","text":"<p>Create <code>samplesheet.csv</code>:</p> <pre><code>path,arm,batch,plate,well,channels,site,cycle,n_frames\n/data/painting/,painting,batch1,P001,A01,DAPI-GFP-RFP-Cy5-Cy3,1,,4\n/data/painting/,painting,batch1,P001,A01,DAPI-GFP-RFP-Cy5-Cy3,2,,4\n/data/barcoding/,barcoding,batch1,P001,A01,Cy3-Cy5,1,1,4\n/data/barcoding/,barcoding,batch1,P001,A01,Cy3-Cy5,1,2,4\n/data/barcoding/,barcoding,batch1,P001,A01,Cy3-Cy5,1,3,4\n</code></pre> <p>!!! note - <code>painting</code> rows have empty <code>cycle</code> column - <code>barcoding</code> rows must have <code>cycle</code> values - <code>path</code> should point to directory containing TIFF images</p>"},{"location":"getting-started/quickstart/#understanding-outputs","title":"Understanding Outputs","text":"<p>After successful execution, find outputs in <code>results/</code>:</p> <pre><code>results/\n\u251c\u2500\u2500 painting/\n\u2502   \u251c\u2500\u2500 illum/              # Illumination functions (.npy)\n\u2502   \u251c\u2500\u2500 corrected/          # Corrected TIFF images\n\u2502   \u2514\u2500\u2500 stitched_cropped/   # Stitched images\n\u251c\u2500\u2500 barcoding/\n\u2502   \u251c\u2500\u2500 illum/\n\u2502   \u251c\u2500\u2500 corrected/\n\u2502   \u251c\u2500\u2500 preprocessed/       # Barcode-called images\n\u2502   \u2514\u2500\u2500 stitched_cropped/\n\u251c\u2500\u2500 combined/\n\u2502   \u2514\u2500\u2500 analysis/           # Final segmentation and measurements\n\u251c\u2500\u2500 qc/\n\u2502   \u251c\u2500\u2500 montage_illum/\n\u2502   \u251c\u2500\u2500 montage_segcheck/\n\u2502   \u251c\u2500\u2500 montage_preprocess/\n\u2502   \u251c\u2500\u2500 montage_stitchcrop/\n\u2502   \u2514\u2500\u2500 barcode_align/\n\u2514\u2500\u2500 csvs/\n    \u2514\u2500\u2500 load_data/          # All generated load_data.csv files\n</code></pre>"},{"location":"getting-started/quickstart/#common-issues","title":"Common Issues","text":""},{"location":"getting-started/quickstart/#container-not-found","title":"Container Not Found","text":"<p>Ensure Docker/Singularity is running:</p> <pre><code>docker ps  # For Docker\nsingularity --version  # For Singularity\n</code></pre>"},{"location":"getting-started/quickstart/#out-of-memory","title":"Out of Memory","text":"<p>Increase JVM memory:</p> <pre><code>export NXF_OPTS='-Xms1g -Xmx4g'\n</code></pre>"},{"location":"getting-started/quickstart/#plugin-download-failures","title":"Plugin Download Failures","text":"<p>Check plugin URLs are accessible:</p> <pre><code>curl -I https://example.com/callbarcodes.py\n</code></pre>"},{"location":"getting-started/quickstart/#next-steps","title":"Next Steps","text":"<ul> <li>Parameters Guide - Fine-tune pipeline behavior</li> <li>Running on Seqera Platform - Scale to cloud/HPC</li> <li>Architecture - Understand pipeline internals</li> </ul>"},{"location":"reference/outputs/","title":"Output Reference","text":"<p>Complete reference for pipeline outputs and their organization.</p>"},{"location":"reference/outputs/#output-directory-structure","title":"Output Directory Structure","text":"<pre><code>results/\n\u251c\u2500\u2500 painting/\n\u2502   \u251c\u2500\u2500 illum/\n\u2502   \u251c\u2500\u2500 corrected/\n\u2502   \u2514\u2500\u2500 stitched_cropped/\n\u251c\u2500\u2500 barcoding/\n\u2502   \u251c\u2500\u2500 illum/\n\u2502   \u251c\u2500\u2500 corrected/\n\u2502   \u251c\u2500\u2500 preprocessed/\n\u2502   \u2514\u2500\u2500 stitched_cropped/\n\u251c\u2500\u2500 combined/\n\u2502   \u2514\u2500\u2500 analysis/\n\u251c\u2500\u2500 qc/\n\u2502   \u251c\u2500\u2500 montage_illum/\n\u2502   \u251c\u2500\u2500 montage_segcheck/\n\u2502   \u251c\u2500\u2500 montage_preprocess/\n\u2502   \u251c\u2500\u2500 montage_stitchcrop/\n\u2502   \u2514\u2500\u2500 barcode_align/\n\u251c\u2500\u2500 csvs/\n\u2502   \u2514\u2500\u2500 load_data/\n\u2514\u2500\u2500 pipeline_info/\n    \u251c\u2500\u2500 execution_report.html\n    \u251c\u2500\u2500 execution_timeline.html\n    \u2514\u2500\u2500 execution_trace.txt\n</code></pre>"},{"location":"reference/outputs/#cell-painting-outputs","title":"Cell Painting Outputs","text":""},{"location":"reference/outputs/#illumination-functions","title":"Illumination Functions","text":"<p>Location: <code>results/painting/illum/</code></p> <p>Files:</p> <pre><code>{batch}/\n  {plate}/\n    {plate}_Illum{channel}.npy\n</code></pre> <p>Description: NumPy arrays containing illumination correction functions for each channel. Used to correct uneven illumination across the field of view.</p> <p>Example:</p> <pre><code>results/painting/illum/batch1/P001/\n  P001_IllumDAPI.npy\n  P001_IllumGFP.npy\n  P001_IllumRFP.npy\n</code></pre>"},{"location":"reference/outputs/#corrected-images","title":"Corrected Images","text":"<p>Location: <code>results/painting/corrected/</code></p> <p>Files:</p> <pre><code>{batch}/\n  {plate}/\n    {well}/\n      {plate}_{well}_{site}_Corr{channel}.tif\n</code></pre> <p>Description: Multi-frame TIFF images with illumination correction applied. One file per channel per site.</p> <p>Example:</p> <pre><code>results/painting/corrected/batch1/P001/A01/\n  P001_A01_1_CorrDAPI.tif\n  P001_A01_1_CorrGFP.tif\n  P001_A01_1_CorrRFP.tif\n</code></pre>"},{"location":"reference/outputs/#stitched-and-cropped-images","title":"Stitched and Cropped Images","text":"<p>Location: <code>results/painting/stitched_cropped/</code></p> <p>Files:</p> <pre><code>{batch}/\n  {plate}/\n    {well}/\n      {site}/\n        {plate}_{well}_{site}_Stitched{channel}.tif\n</code></pre> <p>Description: Stitched full-resolution images for each site, cropped to remove overlap regions. Generated only if <code>qc_painting_passed == true</code>.</p>"},{"location":"reference/outputs/#barcoding-outputs","title":"Barcoding Outputs","text":""},{"location":"reference/outputs/#illumination-functions_1","title":"Illumination Functions","text":"<p>Location: <code>results/barcoding/illum/</code></p> <p>Files:</p> <pre><code>{batch}/\n  {plate}/\n    {cycle}/\n      {plate}_Cycle{cycle}_Illum{channel}.npy\n</code></pre> <p>Description: Cycle-specific illumination correction functions.</p> <p>Example:</p> <pre><code>results/barcoding/illum/batch1/P001/1/\n  P001_Cycle1_IllumCy3.npy\n  P001_Cycle1_IllumCy5.npy\n</code></pre>"},{"location":"reference/outputs/#corrected-images_1","title":"Corrected Images","text":"<p>Location: <code>results/barcoding/corrected/</code></p> <p>Files:</p> <pre><code>{batch}/\n  {plate}/\n    {well}/\n      {site}/\n        {cycle}/\n          {plate}_{well}_{site}_{frame}_Cycle{cycle}_{channel}.tif\n</code></pre> <p>Description: Illumination-corrected barcoding images, organized by cycle.</p>"},{"location":"reference/outputs/#preprocessed-images","title":"Preprocessed Images","text":"<p>Location: <code>results/barcoding/preprocessed/</code></p> <p>Files:</p> <pre><code>{batch}/\n  {plate}/\n    {well}/\n      {site}/\n        {plate}_{well}_{site}_{frame}_Cycle{cycle}_{channel}.tif\n</code></pre> <p>Description: Barcode-called and color-compensated images. Ready for stitching and combined analysis.</p>"},{"location":"reference/outputs/#stitched-and-cropped-images_1","title":"Stitched and Cropped Images","text":"<p>Location: <code>results/barcoding/stitched_cropped/</code></p> <p>Files: Similar structure to painting, with cycle information preserved.</p> <p>Description: Stitched preprocessed images. Generated only if <code>qc_barcoding_passed == true</code>.</p>"},{"location":"reference/outputs/#combined-analysis-outputs","title":"Combined Analysis Outputs","text":""},{"location":"reference/outputs/#segmentation-masks","title":"Segmentation Masks","text":"<p>Location: <code>results/combined/analysis/{batch}/{plate}/{well}/{site}/</code></p> <p>Files:</p> <pre><code>{plate}_{well}_{site}_Nuclei.tif\n{plate}_{well}_{site}_Cells.tif\n{plate}_{well}_{site}_Cytoplasm.tif\n</code></pre> <p>Description: Binary masks for segmented objects:</p> <ul> <li>Nuclei: Nuclear segmentation</li> <li>Cells: Whole cell segmentation</li> <li>Cytoplasm: Cytoplasm only (Cells - Nuclei)</li> </ul>"},{"location":"reference/outputs/#overlay-images","title":"Overlay Images","text":"<p>Files:</p> <pre><code>{plate}_{well}_{site}_Overlay.tif\n</code></pre> <p>Description: RGB composite images showing segmentation overlays on original images.</p>"},{"location":"reference/outputs/#feature-measurements","title":"Feature Measurements","text":"<p>Files:</p> <pre><code>Image.csv\nNuclei.csv\nCells.csv\nCytoplasm.csv\nExperiment.csv\n</code></pre> <p>Description: CSV files containing extracted features and measurements.</p>"},{"location":"reference/outputs/#imagecsv","title":"Image.csv","text":"<p>Per-image measurements:</p> Column Description <code>ImageNumber</code> Unique image identifier <code>Metadata_Plate</code> Plate identifier <code>Metadata_Well</code> Well position <code>Metadata_Site</code> Site number <code>Count_Nuclei</code> Number of nuclei detected <code>Count_Cells</code> Number of cells detected"},{"location":"reference/outputs/#nucleicsv-cellscsv","title":"Nuclei.csv / Cells.csv","text":"<p>Per-object measurements:</p> Column Description <code>ObjectNumber</code> Unique object ID within image <code>ImageNumber</code> Reference to Image.csv <code>Metadata_Barcode</code> Assigned barcode sequence <code>Location_Center_X</code> X coordinate of object center <code>Location_Center_Y</code> Y coordinate of object center <code>AreaShape_Area</code> Object area in pixels <code>Intensity_MeanIntensity_*</code> Mean intensity per channel <code>Texture_*</code> Texture features <code>Granularity_*</code> Granularity features"},{"location":"reference/outputs/#experimentcsv","title":"Experiment.csv","text":"<p>Pipeline metadata and run parameters.</p>"},{"location":"reference/outputs/#quality-control-outputs","title":"Quality Control Outputs","text":""},{"location":"reference/outputs/#illumination-montages","title":"Illumination Montages","text":"<p>Location: <code>results/qc/montage_illum/</code></p> <p>Files:</p> <pre><code>{arm}/{batch}/{plate}/\n  {plate}_IllumMontage_{channel}.png\n</code></pre> <p>Description: Visual summary of illumination correction functions. Shows original vs. corrected illumination patterns.</p>"},{"location":"reference/outputs/#segmentation-check-montages","title":"Segmentation Check Montages","text":"<p>Location: <code>results/qc/montage_segcheck/</code></p> <p>Files:</p> <pre><code>{batch}/{plate}/{well}/\n  {plate}_{well}_SegCheckMontage.png\n</code></pre> <p>Description: Visual QC for segmentation quality. Shows sample sites with segmentation overlays.</p>"},{"location":"reference/outputs/#preprocessing-montages","title":"Preprocessing Montages","text":"<p>Location: <code>results/qc/montage_preprocess/</code></p> <p>Files:</p> <pre><code>{batch}/{plate}/{well}/{site}/\n  {plate}_{well}_{site}_PreprocessMontage.png\n</code></pre> <p>Description: Visual QC for barcoding preprocessing. Shows barcode calling results across cycles.</p>"},{"location":"reference/outputs/#stitchcrop-montages","title":"Stitch/Crop Montages","text":"<p>Location: <code>results/qc/montage_stitchcrop/</code></p> <p>Files: Montages showing stitching quality and overlap regions.</p>"},{"location":"reference/outputs/#barcode-alignment-qc","title":"Barcode Alignment QC","text":"<p>Location: <code>results/qc/barcode_align/</code></p> <p>Files:</p> <pre><code>{batch}/{plate}/\n  shift_summary.csv\n  correlation_matrix.csv\n  shift_spatial_plot.png\n  correlation_heatmap.png\n  qc_report.html\n</code></pre> <p>Description:</p> <ul> <li>shift_summary.csv: Per-site pixel shift statistics</li> <li>correlation_matrix.csv: Cycle-to-cycle correlation coefficients</li> <li>Plots: Visual summaries of alignment quality</li> <li>qc_report.html: Interactive QC dashboard</li> </ul>"},{"location":"reference/outputs/#shift_summarycsv","title":"shift_summary.csv","text":"Column Description <code>Plate</code> Plate identifier <code>Well</code> Well position <code>Site</code> Site number <code>Mean_Shift_X</code> Mean X-axis pixel shift <code>Mean_Shift_Y</code> Mean Y-axis pixel shift <code>Max_Shift</code> Maximum shift magnitude <code>Pass</code> Boolean QC pass/fail"},{"location":"reference/outputs/#load-data-csv-archive","title":"Load Data CSV Archive","text":"<p>Location: <code>results/csvs/load_data/</code></p> <p>Files: All generated <code>load_data.csv</code> files used by CellProfiler processes.</p> <p>Description: Archived for reproducibility and debugging. Organized by process and metadata.</p>"},{"location":"reference/outputs/#pipeline-information","title":"Pipeline Information","text":"<p>Location: <code>results/pipeline_info/</code></p> <p>Files:</p> <ul> <li><code>execution_report.html</code>: Resource usage and task statistics</li> <li><code>execution_timeline.html</code>: Timeline visualization</li> <li><code>execution_trace.txt</code>: Detailed execution log</li> </ul> <p>Usage:</p> <pre><code>nextflow run main.nf -with-report results/pipeline_info/execution_report.html\n</code></pre>"},{"location":"reference/outputs/#output-file-formats","title":"Output File Formats","text":""},{"location":"reference/outputs/#tiff-images","title":"TIFF Images","text":"<ul> <li>Format: Multi-page TIFF (one page per frame)</li> <li>Bit depth: 16-bit unsigned integer</li> <li>Compression: LZW (optional)</li> <li>Metadata: ImageJ-compatible TIFF tags</li> </ul>"},{"location":"reference/outputs/#numpy-arrays-npy","title":"NumPy Arrays (.npy)","text":"<ul> <li>Format: NumPy binary format</li> <li>Shape: <code>(height, width)</code> or <code>(height, width, channels)</code></li> <li>Dtype: <code>float32</code> or <code>float64</code></li> </ul>"},{"location":"reference/outputs/#csv-files","title":"CSV Files","text":"<ul> <li>Format: Comma-separated values</li> <li>Encoding: UTF-8</li> <li>Header: First row contains column names</li> <li>Separator: Comma (<code>,</code>)</li> </ul>"},{"location":"reference/outputs/#png-images","title":"PNG Images","text":"<ul> <li>Format: PNG</li> <li>Bit depth: 8-bit RGB</li> <li>Compression: PNG default</li> </ul>"},{"location":"reference/outputs/#storage-requirements","title":"Storage Requirements","text":"<p>Approximate storage needs (example experiment):</p> Component Per Plate Per Experiment (96 wells) Raw images 50 GB 5 TB Illumination functions 100 MB 10 GB Corrected images 50 GB 5 TB Stitched images 20 GB 2 TB Segmentation masks 5 GB 500 GB Feature CSVs 500 MB 50 GB QC outputs 1 GB 100 GB Total ~127 GB ~12.7 TB <p>!!! note \"Storage Optimization\" - Enable compression for TIFF files - Archive intermediate outputs after QC - Use cloud tiered storage for older results</p>"},{"location":"reference/outputs/#accessing-outputs","title":"Accessing Outputs","text":""},{"location":"reference/outputs/#from-nextflow","title":"From Nextflow","text":"<p>Outputs are published to <code>params.outdir</code>:</p> <pre><code>publishDir \"${params.outdir}/painting/corrected\", mode: 'copy'\n</code></pre>"},{"location":"reference/outputs/#from-python","title":"From Python","text":"<pre><code>import pandas as pd\nfrom PIL import Image\nimport numpy as np\n\n# Read feature data\ncells = pd.read_csv('results/combined/analysis/batch1/P001/A01/1/Cells.csv')\n\n# Load segmentation mask\nnuclei = Image.open('results/combined/analysis/batch1/P001/A01/1/P001_A01_1_Nuclei.tif')\n\n# Load illumination function\nillum = np.load('results/painting/illum/batch1/P001/P001_IllumDAPI.npy')\n</code></pre>"},{"location":"reference/outputs/#from-r","title":"From R","text":"<pre><code>library(readr)\nlibrary(tiff)\n\n# Read feature data\ncells &lt;- read_csv('results/combined/analysis/batch1/P001/A01/1/Cells.csv')\n\n# Load image\nnuclei &lt;- readTIFF('results/combined/analysis/batch1/P001/A01/1/P001_A01_1_Nuclei.tif')\n</code></pre>"},{"location":"reference/outputs/#next-steps","title":"Next Steps","text":"<ul> <li>Parameters - Configure output behavior</li> <li>Architecture - Understand output generation</li> <li>Troubleshooting - Resolve output issues</li> </ul>"},{"location":"reference/troubleshooting/","title":"Troubleshooting","text":"<p>Common issues and solutions for the nf-pooled-cellpainting pipeline.</p>"},{"location":"reference/troubleshooting/#pipeline-execution-issues","title":"Pipeline Execution Issues","text":""},{"location":"reference/troubleshooting/#pipeline-fails-to-start","title":"Pipeline Fails to Start","text":""},{"location":"reference/troubleshooting/#symptom","title":"Symptom","text":"<pre><code>ERROR ~ Error executing process &gt; 'CELLPAINTING:CELLPROFILER_ILLUMCALC'\n</code></pre>"},{"location":"reference/troubleshooting/#causes-solutions","title":"Causes &amp; Solutions","text":"<p>1. Missing required parameters</p> <p>Check all required parameters are provided:</p> <pre><code>nextflow run main.nf --help\n</code></pre> <p>Ensure you have:</p> <ul> <li><code>--input</code></li> <li><code>--barcodes</code></li> <li><code>--outdir</code></li> <li>All CellProfiler pipeline paths</li> <li>Plugin URLs</li> </ul> <p>2. Invalid samplesheet</p> <p>Validate CSV format:</p> <pre><code>head samplesheet.csv\n# Should have headers: path,arm,batch,plate,well,channels,site,cycle,n_frames\n</code></pre> <p>3. Nextflow version</p> <p>Update Nextflow:</p> <pre><code>nextflow self-update\nnextflow -version  # Should be &gt;= 23.04.0\n</code></pre>"},{"location":"reference/troubleshooting/#processes-fail-with-cannot-find-file","title":"Processes Fail with \"Cannot find file\"","text":""},{"location":"reference/troubleshooting/#symptom_1","title":"Symptom","text":"<pre><code>ERROR ~ Error executing process &gt; 'CELLPROFILER_ILLUMCALC'\nCaused by:\n  Process `CELLPROFILER_ILLUMCALC` terminated with an error exit status (1)\n  Cannot find file: /path/to/images\n</code></pre>"},{"location":"reference/troubleshooting/#solutions","title":"Solutions","text":"<p>1. Check file paths in samplesheet</p> <p>Ensure paths are:</p> <ul> <li>Absolute paths (recommended)</li> <li>Accessible from execution environment</li> <li>Point to directories containing images</li> </ul> <pre><code># Test file accessibility\ncat samplesheet.csv | tail -n +2 | cut -d',' -f1 | xargs -I {} ls {}\n</code></pre> <p>2. Cloud storage authentication</p> <p>For S3/Azure/GCS paths, verify credentials:</p> <pre><code># AWS\naws s3 ls s3://bucket/path/\n\n# Azure\naz storage blob list --account-name myaccount --container-name mycontainer\n\n# Google Cloud\ngsutil ls gs://bucket/path/\n</code></pre>"},{"location":"reference/troubleshooting/#out-of-memory-errors","title":"Out of Memory Errors","text":""},{"location":"reference/troubleshooting/#symptom_2","title":"Symptom","text":"<pre><code>ERROR ~ Error executing process &gt; 'CELLPROFILER_ILLUMCALC'\njava.lang.OutOfMemoryError: Java heap space\n</code></pre> <p>or</p> <pre><code>CellProfiler: MemoryError: Unable to allocate array\n</code></pre>"},{"location":"reference/troubleshooting/#solutions_1","title":"Solutions","text":"<p>1. Increase Java heap size</p> <pre><code>export NXF_OPTS='-Xms2g -Xmx8g'\nnextflow run main.nf ...\n</code></pre> <p>2. Increase process memory</p> <p>Create <code>nextflow.config</code>:</p> <pre><code>process {\n    withName: 'CELLPROFILER_.*' {\n        memory = { task.attempt == 1 ? 32.GB : 64.GB }\n        errorStrategy = 'retry'\n        maxRetries = 2\n    }\n}\n</code></pre> <p>3. Reduce parallelization</p> <pre><code>executor {\n    queueSize = 4  // Reduce concurrent tasks\n}\n</code></pre> <p>4. Process smaller batches</p> <p>Split samplesheet into smaller subsets and run separately.</p>"},{"location":"reference/troubleshooting/#work-directory-full","title":"Work Directory Full","text":""},{"location":"reference/troubleshooting/#symptom_3","title":"Symptom","text":"<pre><code>ERROR ~ Error executing process &gt; 'CELLPROFILER_ILLUMAPPLY'\nNo space left on device\n</code></pre>"},{"location":"reference/troubleshooting/#solutions_2","title":"Solutions","text":"<p>1. Clean work directory</p> <pre><code># Remove failed task work directories\nnextflow clean -f\n\n# Keep only successful cached tasks\nnextflow clean -f -k\n</code></pre> <p>2. Change work directory</p> <pre><code>nextflow run main.nf -w /path/to/large/disk/work ...\n</code></pre> <p>3. Monitor disk usage</p> <pre><code>df -h\ndu -sh work/\n</code></pre>"},{"location":"reference/troubleshooting/#cellprofiler-issues","title":"CellProfiler Issues","text":""},{"location":"reference/troubleshooting/#cellprofiler-process-fails","title":"CellProfiler Process Fails","text":""},{"location":"reference/troubleshooting/#symptom_4","title":"Symptom","text":"<pre><code>CellProfiler: Error while processing ...\n</code></pre>"},{"location":"reference/troubleshooting/#solutions_3","title":"Solutions","text":"<p>1. Check load_data.csv</p> <p>Examine generated CSV:</p> <pre><code># Find work directory\nls -lrt work/*/*/\n\n# Check CSV\ncat work/a1/b2c3.../load_data.csv\n</code></pre> <p>Verify:</p> <ul> <li>Correct column names</li> <li>Valid file paths</li> <li>No missing values</li> </ul> <p>2. Test pipeline manually</p> <p>Extract and run CellProfiler directly:</p> <pre><code>cd work/&lt;task-hash&gt;/\n\ncellprofiler \\\n    -c -r \\\n    -p pipeline.cppipe \\\n    --log-level=DEBUG \\\n    --data-file=load_data.csv\n</code></pre> <p>3. Validate .cppipe file</p> <p>Open in CellProfiler GUI:</p> <pre><code>cellprofiler  # Opens GUI\n# Load pipeline and check for errors\n</code></pre>"},{"location":"reference/troubleshooting/#plugin-download-failures","title":"Plugin Download Failures","text":""},{"location":"reference/troubleshooting/#symptom_5","title":"Symptom","text":"<pre><code>wget: unable to resolve host address\nERROR: Plugin 'callbarcodes' not found\n</code></pre>"},{"location":"reference/troubleshooting/#solutions_4","title":"Solutions","text":"<p>1. Check URL accessibility</p> <pre><code>curl -I https://example.com/callbarcodes.py\n</code></pre> <p>2. Use local files</p> <p>Download plugins locally:</p> <pre><code>wget -O plugins/callbarcodes.py https://example.com/callbarcodes.py\n</code></pre> <p>Update parameters:</p> <pre><code>--callbarcodes_plugin file:$PWD/plugins/callbarcodes.py\n</code></pre> <p>3. Check network connectivity</p> <p>Ensure compute environment can access external URLs.</p>"},{"location":"reference/troubleshooting/#illumination-correction-issues","title":"Illumination Correction Issues","text":""},{"location":"reference/troubleshooting/#symptom_6","title":"Symptom","text":"<p>Corrected images look wrong or unchanged.</p>"},{"location":"reference/troubleshooting/#solutions_5","title":"Solutions","text":"<p>1. Verify illumination functions</p> <p>Check <code>.npy</code> files exist and are non-empty:</p> <pre><code>ls -lh results/painting/illum/batch1/P001/*.npy\n</code></pre> <p>Load and inspect:</p> <pre><code>import numpy as np\nimport matplotlib.pyplot as plt\n\nillum = np.load('P001_IllumDAPI.npy')\nplt.imshow(illum)\nplt.colorbar()\nplt.show()\n</code></pre> <p>2. Check pipeline configuration</p> <p>Ensure <code>illumapply</code> pipeline:</p> <ul> <li>Loads illumination functions correctly</li> <li>Applies correction formula (usually divide or subtract)</li> <li>Saves corrected output</li> </ul>"},{"location":"reference/troubleshooting/#qc-gate-issues","title":"QC Gate Issues","text":""},{"location":"reference/troubleshooting/#pipeline-stops-before-stitching","title":"Pipeline Stops Before Stitching","text":""},{"location":"reference/troubleshooting/#symptom_7","title":"Symptom","text":"<p>No stitched outputs despite successful execution.</p>"},{"location":"reference/troubleshooting/#solution","title":"Solution","text":"<p>This is expected behavior! Enable QC gates after manual review:</p> <pre><code>nextflow run main.nf \\\n    ... \\\n    --qc_painting_passed true \\\n    --qc_barcoding_passed true \\\n    -resume\n</code></pre>"},{"location":"reference/troubleshooting/#qc-metrics-dont-match-expectations","title":"QC Metrics Don't Match Expectations","text":""},{"location":"reference/troubleshooting/#barcode-alignment-fails-qc","title":"Barcode Alignment Fails QC","text":"<p>Symptom: High pixel shifts or low correlations</p> <p>Solutions:</p> <ol> <li>Adjust thresholds:</li> </ol> <pre><code>--barcoding_shift_threshold 100  # Increase from 50\n--barcoding_corr_threshold 0.8   # Decrease from 0.9\n</code></pre> <ol> <li>Inspect QC outputs:</li> </ol> <pre><code>open results/qc/barcode_align/batch1/P001/qc_report.html\n</code></pre> <ol> <li>Check imaging quality: May indicate stage drift or focus issues.</li> </ol>"},{"location":"reference/troubleshooting/#container-issues","title":"Container Issues","text":""},{"location":"reference/troubleshooting/#docker-permission-denied","title":"Docker Permission Denied","text":""},{"location":"reference/troubleshooting/#symptom_8","title":"Symptom","text":"<pre><code>ERROR ~ Error executing process &gt; 'CELLPROFILER_ILLUMCALC'\ndocker: Got permission denied while trying to connect to the Docker daemon socket\n</code></pre>"},{"location":"reference/troubleshooting/#solutions_6","title":"Solutions","text":"<p>1. Add user to docker group</p> <pre><code>sudo usermod -aG docker $USER\nnewgrp docker\n</code></pre> <p>2. Use Docker sudo</p> <pre><code>docker {\n    enabled = true\n    sudo = true\n}\n</code></pre> <p>3. Switch to Singularity</p> <pre><code>nextflow run main.nf -profile singularity ...\n</code></pre>"},{"location":"reference/troubleshooting/#container-image-pull-failures","title":"Container Image Pull Failures","text":""},{"location":"reference/troubleshooting/#symptom_9","title":"Symptom","text":"<pre><code>ERROR ~ Failed to pull Docker image 'wave.seqera.io/cellprofiler/cellprofiler:4.2.8'\n</code></pre>"},{"location":"reference/troubleshooting/#solutions_7","title":"Solutions","text":"<p>1. Check network connectivity</p> <pre><code>docker pull wave.seqera.io/cellprofiler/cellprofiler:4.2.8\n</code></pre> <p>2. Use alternative registry</p> <pre><code>process {\n    container = 'docker.io/cellprofiler/cellprofiler:4.2.8'\n}\n</code></pre> <p>3. Pre-pull images</p> <pre><code>docker pull wave.seqera.io/cellprofiler/cellprofiler:4.2.8\ndocker pull fiji/fiji:20220415\n</code></pre>"},{"location":"reference/troubleshooting/#performance-issues","title":"Performance Issues","text":""},{"location":"reference/troubleshooting/#pipeline-runs-slowly","title":"Pipeline Runs Slowly","text":""},{"location":"reference/troubleshooting/#causes-solutions_1","title":"Causes &amp; Solutions","text":"<p>1. Insufficient parallelization</p> <p>Increase concurrent tasks:</p> <pre><code>executor {\n    queueSize = 20\n}\n</code></pre> <p>2. Over-allocation</p> <p>Too many parallel tasks can cause thrashing. Monitor and adjust:</p> <pre><code>htop  # Watch CPU and memory\n</code></pre> <p>3. I/O bottleneck</p> <p>Use local SSD for work directory:</p> <pre><code>nextflow run main.nf -w /fast/local/disk/work ...\n</code></pre> <p>4. Network latency</p> <p>For cloud storage, ensure compute is in same region:</p> <pre><code>aws {\n    region = 'us-east-1'  # Match S3 bucket region\n}\n</code></pre>"},{"location":"reference/troubleshooting/#tasks-timeout","title":"Tasks Timeout","text":""},{"location":"reference/troubleshooting/#symptom_10","title":"Symptom","text":"<pre><code>ERROR ~ Error executing process &gt; 'CELLPROFILER_ILLUMCALC'\nExecution cancelled -- Execution time limit exceeded\n</code></pre>"},{"location":"reference/troubleshooting/#solution_1","title":"Solution","text":"<p>Increase time limit:</p> <pre><code>process {\n    withName: 'CELLPROFILER_ILLUMCALC' {\n        time = 12.h  // Increase from default\n    }\n}\n</code></pre>"},{"location":"reference/troubleshooting/#output-issues","title":"Output Issues","text":""},{"location":"reference/troubleshooting/#missing-output-files","title":"Missing Output Files","text":""},{"location":"reference/troubleshooting/#symptom_11","title":"Symptom","text":"<p>Expected files not in <code>results/</code>.</p>"},{"location":"reference/troubleshooting/#solutions_8","title":"Solutions","text":"<p>1. Check publishDir configuration</p> <p>Verify publish settings in process:</p> <pre><code>publishDir \"${params.outdir}/painting/corrected\", mode: 'copy'\n</code></pre> <p>2. Check process completion</p> <p>Ensure process succeeded:</p> <pre><code>grep -r \"Completed\" .nextflow.log | grep ILLUMCALC\n</code></pre> <p>3. Check work directory</p> <p>Files may be in work directory:</p> <pre><code>find work/ -name \"*.tif\" | head\n</code></pre>"},{"location":"reference/troubleshooting/#incorrect-output-organization","title":"Incorrect Output Organization","text":""},{"location":"reference/troubleshooting/#symptom_12","title":"Symptom","text":"<p>Files not organized as expected.</p>"},{"location":"reference/troubleshooting/#solution_2","title":"Solution","text":"<p>Verify metadata is correctly parsed:</p> <pre><code>// Check samplesheet parsing\ncat .nextflow.log | grep \"Metadata:\"\n</code></pre> <p>Ensure grouping keys match expectations in subworkflows.</p>"},{"location":"reference/troubleshooting/#seqera-platform-issues","title":"Seqera Platform Issues","text":""},{"location":"reference/troubleshooting/#authentication-failures","title":"Authentication Failures","text":""},{"location":"reference/troubleshooting/#symptom_13","title":"Symptom","text":"<pre><code>ERROR ~ Unable to authenticate to Seqera Platform\n</code></pre>"},{"location":"reference/troubleshooting/#solutions_9","title":"Solutions","text":"<pre><code># Configure credentials\ntw login\n\n# Verify authentication\ntw info\n</code></pre>"},{"location":"reference/troubleshooting/#compute-environment-errors","title":"Compute Environment Errors","text":""},{"location":"reference/troubleshooting/#symptom_14","title":"Symptom","text":"<p>Jobs not launching in cloud/HPC.</p>"},{"location":"reference/troubleshooting/#solutions_10","title":"Solutions","text":"<p>1. Verify compute environment</p> <p>Check Seqera Platform dashboard:</p> <ul> <li>Compute environment status</li> <li>Credentials validity</li> <li>Resource limits</li> </ul> <p>2. Check queue configuration</p> <pre><code>process {\n    queue = 'default'  // Verify queue name\n    clusterOptions = '--account=myaccount'\n}\n</code></pre> <p>3. Review logs in Seqera Platform</p> <p>Navigate to run \u2192 Tasks \u2192 Select failed task \u2192 View logs</p>"},{"location":"reference/troubleshooting/#data-issues","title":"Data Issues","text":""},{"location":"reference/troubleshooting/#metadata-mismatches","title":"Metadata Mismatches","text":""},{"location":"reference/troubleshooting/#symptom_15","title":"Symptom","text":"<p>Files not grouping correctly.</p>"},{"location":"reference/troubleshooting/#solutions_11","title":"Solutions","text":"<p>1. Validate samplesheet</p> <pre><code>import pandas as pd\n\ndf = pd.read_csv('samplesheet.csv')\n\n# Check for duplicates\nduplicates = df[df.duplicated(subset=['batch', 'plate', 'well', 'site', 'cycle'], keep=False)]\nprint(duplicates)\n\n# Check for missing values\nprint(df.isnull().sum())\n</code></pre> <p>2. Verify filename patterns</p> <p>Ensure filenames match expected pattern:</p> <pre><code>{plate}_{well}_{site}_{frame}_{channel}.tif\n</code></pre>"},{"location":"reference/troubleshooting/#image-format-issues","title":"Image Format Issues","text":""},{"location":"reference/troubleshooting/#symptom_16","title":"Symptom","text":"<p>CellProfiler can't read images.</p>"},{"location":"reference/troubleshooting/#solutions_12","title":"Solutions","text":"<p>1. Validate TIFF format</p> <pre><code>from PIL import Image\n\nimg = Image.open('test.tif')\nprint(img.format, img.size, img.mode)\n</code></pre> <p>2. Convert incompatible formats</p> <pre><code>from PIL import Image\nimport numpy as np\n\n# Load and convert\nimg = Image.open('input.png')\nimg_array = np.array(img)\n\n# Save as 16-bit TIFF\nImage.fromarray(img_array.astype('uint16')).save('output.tif')\n</code></pre>"},{"location":"reference/troubleshooting/#getting-help","title":"Getting Help","text":""},{"location":"reference/troubleshooting/#collect-diagnostic-information","title":"Collect Diagnostic Information","text":"<pre><code># Nextflow version\nnextflow -version\n\n# Container versions\ndocker --version\nsingularity --version\n\n# Check logs\ntail -100 .nextflow.log\n\n# Execution report\nnextflow run main.nf -with-report report.html\n</code></pre>"},{"location":"reference/troubleshooting/#report-an-issue","title":"Report an Issue","text":"<p>When reporting issues, include:</p> <ol> <li>Nextflow version: <code>nextflow -version</code></li> <li>Command used: Full <code>nextflow run</code> command</li> <li>Error message: From <code>.nextflow.log</code></li> <li>Work directory: Relevant files from <code>work/&lt;task-hash&gt;/</code></li> <li>Configuration: Custom <code>nextflow.config</code> if any</li> </ol>"},{"location":"reference/troubleshooting/#additional-resources","title":"Additional Resources","text":"<ul> <li>Nextflow Documentation</li> <li>CellProfiler Forum</li> <li>nf-core Guidelines</li> <li>Seqera Platform Docs</li> </ul>"},{"location":"reference/troubleshooting/#next-steps","title":"Next Steps","text":"<ul> <li>Parameters - Adjust pipeline configuration</li> <li>Architecture - Understand pipeline internals</li> <li>Testing - Test your changes</li> </ul>"},{"location":"usage/parameters/","title":"Parameters Reference","text":"<p>Complete reference for all pipeline parameters.</p>"},{"location":"usage/parameters/#required-parameters","title":"Required Parameters","text":""},{"location":"usage/parameters/#inputoutput","title":"Input/Output","text":"Parameter Type Description <code>--input</code> <code>path</code> Samplesheet CSV with columns: <code>path</code>, <code>arm</code>, <code>batch</code>, <code>plate</code>, <code>well</code>, <code>channels</code>, <code>site</code>, <code>cycle</code>, <code>n_frames</code> <code>--barcodes</code> <code>path</code> CSV file with barcode definitions (<code>barcode_id</code>, <code>sequence</code>) <code>--outdir</code> <code>path</code> Output directory for results"},{"location":"usage/parameters/#cellprofiler-pipelines","title":"CellProfiler Pipelines","text":"Parameter Type Description <code>--painting_illumcalc_cppipe</code> <code>path</code> Illumination calculation pipeline for Cell Painting <code>--painting_illumapply_cppipe</code> <code>path</code> Illumination correction pipeline for Cell Painting <code>--painting_segcheck_cppipe</code> <code>path</code> Segmentation QC pipeline <code>--barcoding_illumcalc_cppipe</code> <code>path</code> Illumination calculation pipeline for barcoding <code>--barcoding_illumapply_cppipe</code> <code>path</code> Illumination correction pipeline for barcoding <code>--barcoding_preprocess_cppipe</code> <code>path</code> Barcoding preprocessing pipeline with barcode calling <code>--combinedanalysis_cppipe</code> <code>path</code> Combined analysis pipeline"},{"location":"usage/parameters/#cellprofiler-plugins","title":"CellProfiler Plugins","text":"Parameter Type Description <code>--callbarcodes_plugin</code> <code>string</code> URL or path to <code>callbarcodes.py</code> plugin <code>--compensatecolors_plugin</code> <code>string</code> URL or path to <code>compensatecolors.py</code> plugin"},{"location":"usage/parameters/#cell-painting-parameters","title":"Cell Painting Parameters","text":""},{"location":"usage/parameters/#image-properties","title":"Image Properties","text":"Parameter Type Default Description <code>--cp_img_overlap_pct</code> <code>int</code> <code>10</code> Image overlap percentage for stitching <code>--cp_img_frame_type</code> <code>string</code> <code>\"round\"</code> Frame type: <code>round</code>, <code>square</code>, or custom <code>--cp_acquisition_order</code> <code>string</code> <code>\"snake\"</code> Acquisition order: <code>snake</code>, <code>raster</code>"},{"location":"usage/parameters/#quality-control","title":"Quality Control","text":"Parameter Type Default Description <code>--range_skip</code> <code>int</code> <code>16</code> Sampling frequency for segmentation check (1 in N sites) <code>--qc_painting_passed</code> <code>boolean</code> <code>false</code> Enable progression to stitching after QC review"},{"location":"usage/parameters/#barcoding-parameters","title":"Barcoding Parameters","text":""},{"location":"usage/parameters/#image-properties_1","title":"Image Properties","text":"Parameter Type Default Description <code>--sbs_img_overlap_pct</code> <code>int</code> <code>10</code> Image overlap percentage for stitching <code>--sbs_img_frame_type</code> <code>string</code> <code>\"round\"</code> Frame type: <code>round</code>, <code>square</code>, or custom <code>--sbs_acquisition_order</code> <code>string</code> <code>\"snake\"</code> Acquisition order: <code>snake</code>, <code>raster</code>"},{"location":"usage/parameters/#acquisition-geometry","title":"Acquisition Geometry","text":"Parameter Type Default Description <code>--acquisition_geometry_rows</code> <code>int</code> <code>2</code> Number of rows in acquisition geometry grid <code>--acquisition_geometry_columns</code> <code>int</code> <code>2</code> Number of columns in acquisition geometry grid"},{"location":"usage/parameters/#quality-control_1","title":"Quality Control","text":"Parameter Type Default Description <code>--barcoding_shift_threshold</code> <code>float</code> <code>50.0</code> Maximum allowed pixel shift between cycles (pixels) <code>--barcoding_corr_threshold</code> <code>float</code> <code>0.9</code> Minimum correlation coefficient between cycles <code>--qc_barcoding_passed</code> <code>boolean</code> <code>false</code> Enable progression to stitching after QC review"},{"location":"usage/parameters/#execution-parameters","title":"Execution Parameters","text":""},{"location":"usage/parameters/#container-configuration","title":"Container Configuration","text":"<p>Use <code>-profile</code> to specify container engine:</p> <pre><code>-profile docker          # Docker\n-profile singularity     # Singularity/Apptainer\n-profile podman          # Podman\n</code></pre>"},{"location":"usage/parameters/#resource-configuration","title":"Resource Configuration","text":"<p>Override default resources in a custom config:</p> <pre><code>process {\n    withName: 'CELLPROFILER_.*' {\n        cpus = 4\n        memory = 16.GB\n        time = 4.h\n    }\n}\n</code></pre>"},{"location":"usage/parameters/#execution-backends","title":"Execution Backends","text":"<p>Configure executor in <code>nextflow.config</code>:</p> <pre><code>executor {\n    name = 'slurm'  // or 'sge', 'pbs', 'awsbatch', etc.\n    queueSize = 100\n}\n</code></pre>"},{"location":"usage/parameters/#parameter-files","title":"Parameter Files","text":"<p>Store parameters in a file for reproducibility:</p> <pre><code># params.yml\ninput: \"samplesheet.csv\"\nbarcodes: \"barcodes.csv\"\noutdir: \"results\"\n\ncp_img_overlap_pct: 15\nrange_skip: 8\n\nqc_painting_passed: true\nqc_barcoding_passed: true\n\npainting_illumcalc_cppipe: \"pipelines/painting_illumcalc.cppipe\"\n# ... additional parameters\n</code></pre> <p>Run with:</p> <pre><code>nextflow run main.nf -params-file params.yml\n</code></pre>"},{"location":"usage/parameters/#advanced-configuration","title":"Advanced Configuration","text":""},{"location":"usage/parameters/#skip-specific-processes","title":"Skip Specific Processes","text":"<p>Modify workflow in <code>workflows/nf-pooled-cellpainting.nf</code> to conditionally skip processes.</p>"},{"location":"usage/parameters/#custom-channel-grouping","title":"Custom Channel Grouping","text":"<p>The pipeline automatically groups images by metadata. To customize, modify channel logic in subworkflows.</p>"},{"location":"usage/parameters/#plugin-configuration","title":"Plugin Configuration","text":"<p>Plugins are downloaded once and cached. To update:</p> <pre><code>rm -rf work/\nnextflow run main.nf ... -resume\n</code></pre>"},{"location":"usage/parameters/#examples","title":"Examples","text":""},{"location":"usage/parameters/#high-throughput-run","title":"High-throughput Run","text":"<pre><code>nextflow run main.nf \\\n  --input large_samplesheet.csv \\\n  --range_skip 32 \\\n  --cp_img_overlap_pct 5 \\\n  --sbs_img_overlap_pct 5 \\\n  -profile docker \\\n  -resume\n</code></pre>"},{"location":"usage/parameters/#quick-qc-check","title":"Quick QC Check","text":"<pre><code>nextflow run main.nf \\\n  --input subset_samplesheet.csv \\\n  --range_skip 4 \\\n  -profile docker\n</code></pre>"},{"location":"usage/parameters/#production-run-with-qc-gates","title":"Production Run with QC Gates","text":"<pre><code>nextflow run main.nf \\\n  --input samplesheet.csv \\\n  --qc_painting_passed true \\\n  --qc_barcoding_passed true \\\n  -profile singularity \\\n  -resume\n</code></pre>"},{"location":"usage/parameters/#see-also","title":"See Also","text":"<ul> <li>Quick Start - Basic usage examples</li> <li>Architecture - Understanding parameter effects</li> <li>Troubleshooting - Common parameter issues</li> </ul>"},{"location":"usage/running-locally/","title":"Running Locally","text":"<p>Guide for running the pipeline on local workstations and compute servers.</p>"},{"location":"usage/running-locally/#prerequisites","title":"Prerequisites","text":"<ul> <li>Nextflow installed</li> <li>Docker or Singularity configured</li> <li>Sufficient storage for image data</li> <li>Adequate compute resources (recommended: 8+ cores, 32+ GB RAM)</li> </ul>"},{"location":"usage/running-locally/#configuration","title":"Configuration","text":""},{"location":"usage/running-locally/#local-execution-profile","title":"Local Execution Profile","text":"<p>Create <code>conf/local.config</code>:</p> <pre><code>process {\n    executor = 'local'\n    cpus = 8\n    memory = 32.GB\n\n    withName: 'CELLPROFILER_.*' {\n        cpus = 4\n        memory = 16.GB\n    }\n\n    withName: 'FIJI_.*' {\n        cpus = 2\n        memory = 8.GB\n    }\n}\n\ndocker {\n    enabled = true\n    runOptions = '-u $(id -u):$(id -g)'\n}\n</code></pre>"},{"location":"usage/running-locally/#using-the-profile","title":"Using the Profile","text":"<pre><code>nextflow run main.nf \\\n  --input samplesheet.csv \\\n  -c conf/local.config \\\n  -resume\n</code></pre>"},{"location":"usage/running-locally/#storage-considerations","title":"Storage Considerations","text":""},{"location":"usage/running-locally/#work-directory","title":"Work Directory","text":"<p>Nextflow stores intermediate files in <code>work/</code>. Size requirements:</p> <ul> <li>Raw images: Original size \u00d7 number of processing steps</li> <li>Corrected images: Similar to raw images</li> <li>Stitched images: Variable based on stitching configuration</li> </ul> <p>Storage Management</p> <p>Use <code>-resume</code> to avoid re-computing completed tasks. Clean work directory periodically: <code>bash     nextflow clean -f</code></p>"},{"location":"usage/running-locally/#output-directory","title":"Output Directory","text":"<p>Final outputs are stored in <code>--outdir</code>. Size:</p> <ul> <li>Illumination functions: ~MB per plate</li> <li>Corrected images: ~GB per plate</li> <li>Stitched images: Variable</li> <li>CSV files: ~MB</li> </ul>"},{"location":"usage/running-locally/#performance-tuning","title":"Performance Tuning","text":""},{"location":"usage/running-locally/#parallel-execution","title":"Parallel Execution","text":"<p>Control concurrent jobs:</p> <pre><code>executor {\n    queueSize = 8  // Max parallel tasks\n}\n</code></pre>"},{"location":"usage/running-locally/#process-specific-resources","title":"Process-Specific Resources","text":"<p>Fine-tune resource allocation:</p> <pre><code>process {\n    withName: 'CELLPROFILER_ILLUMCALC' {\n        cpus = 8\n        memory = 32.GB\n        time = 8.h\n    }\n\n    withName: 'CELLPROFILER_ILLUMAPPLY' {\n        cpus = 4\n        memory = 16.GB\n        time = 4.h\n    }\n}\n</code></pre>"},{"location":"usage/running-locally/#container-caching","title":"Container Caching","text":"<p>Enable container caching to speed up reruns:</p> DockerSingularity <pre><code>docker {\n    enabled = true\n    fixOwnership = true\n    runOptions = '-u $(id -u):$(id -g)'\n}\n</code></pre> <pre><code>singularity {\n    enabled = true\n    autoMounts = true\n    cacheDir = '/path/to/singularity/cache'\n}\n</code></pre>"},{"location":"usage/running-locally/#monitoring","title":"Monitoring","text":""},{"location":"usage/running-locally/#real-time-progress","title":"Real-time Progress","text":"<p>Monitor execution:</p> <pre><code># In separate terminal\ntail -f .nextflow.log\n</code></pre>"},{"location":"usage/running-locally/#resource-usage","title":"Resource Usage","text":"<p>Check system resources:</p> <pre><code># CPU and memory\nhtop\n\n# Disk usage\ndf -h\ndu -sh work/\n</code></pre>"},{"location":"usage/running-locally/#nextflow-reports","title":"Nextflow Reports","text":"<p>Generate execution reports:</p> <pre><code>nextflow run main.nf \\\n  --input samplesheet.csv \\\n  -with-report report.html \\\n  -with-timeline timeline.html \\\n  -with-dag dag.html\n</code></pre>"},{"location":"usage/running-locally/#troubleshooting","title":"Troubleshooting","text":""},{"location":"usage/running-locally/#out-of-memory","title":"Out of Memory","text":"<p>Reduce parallelization:</p> <pre><code>executor {\n    queueSize = 4\n}\n\nprocess {\n    memory = 16.GB\n}\n</code></pre>"},{"location":"usage/running-locally/#disk-space","title":"Disk Space","text":"<p>Monitor and clean:</p> <pre><code># Check usage\ndu -sh work/ results/\n\n# Clean work directory\nnextflow clean -f -k\n</code></pre>"},{"location":"usage/running-locally/#container-issues","title":"Container Issues","text":"<p>Test container accessibility:</p> <pre><code>docker run --rm wave.seqera.io/cellprofiler/cellprofiler:4.2.8 cellprofiler --version\n</code></pre>"},{"location":"usage/running-locally/#best-practices","title":"Best Practices","text":"<ol> <li>Use <code>-resume</code>: Always resume failed runs</li> <li>Monitor resources: Watch CPU, memory, and disk usage</li> <li>Test with subset: Validate with small dataset first</li> <li>Clean regularly: Remove old work directories</li> <li>Version control: Track pipeline version and parameters</li> </ol>"},{"location":"usage/running-locally/#example-configurations","title":"Example Configurations","text":""},{"location":"usage/running-locally/#small-workstation-16-gb-ram","title":"Small Workstation (16 GB RAM)","text":"<pre><code>process {\n    executor = 'local'\n    cpus = 4\n    memory = 8.GB\n}\n\nexecutor {\n    queueSize = 2\n}\n</code></pre>"},{"location":"usage/running-locally/#high-end-server-128-gb-ram","title":"High-end Server (128 GB RAM)","text":"<pre><code>process {\n    executor = 'local'\n    cpus = 16\n    memory = 64.GB\n}\n\nexecutor {\n    queueSize = 16\n}\n</code></pre>"},{"location":"usage/running-locally/#next-steps","title":"Next Steps","text":"<ul> <li>Seqera Platform - Scale to cloud/HPC</li> <li>Troubleshooting - Solve common issues</li> </ul>"},{"location":"usage/seqera-platform/","title":"Running on Seqera Platform","text":"<p>Execute the pipeline on cloud and HPC infrastructure using Seqera Platform.</p>"},{"location":"usage/seqera-platform/#overview","title":"Overview","text":"<p>Seqera Platform provides:</p> <ul> <li>Cloud execution: AWS, Azure, Google Cloud</li> <li>HPC integration: SLURM, SGE, PBS, LSF</li> <li>Resource optimization: Auto-scaling and cost management</li> <li>Monitoring: Real-time execution dashboards</li> <li>Collaboration: Team workspaces and sharing</li> </ul>"},{"location":"usage/seqera-platform/#getting-started","title":"Getting Started","text":""},{"location":"usage/seqera-platform/#prerequisites","title":"Prerequisites","text":"<ul> <li>Seqera Platform account (sign up at cloud.seqera.io)</li> <li>Compute environment configured (AWS Batch, Azure Batch, HPC cluster, etc.)</li> <li>Pipeline repository accessible (GitHub, GitLab, Bitbucket)</li> </ul>"},{"location":"usage/seqera-platform/#create-compute-environment","title":"Create Compute Environment","text":"<ol> <li>Navigate to Compute Environments in Seqera Platform</li> <li>Click Add Compute Environment</li> <li>Select your infrastructure:</li> <li>AWS Batch: Automatic EC2 provisioning</li> <li>Azure Batch: Azure VM provisioning</li> <li>Google Cloud Batch: GCP compute instances</li> <li>HPC Cluster: SLURM, SGE, PBS, LSF</li> <li>Configure credentials and resource limits</li> <li>Save the compute environment</li> </ol>"},{"location":"usage/seqera-platform/#add-pipeline","title":"Add Pipeline","text":"<ol> <li>Go to Launchpad</li> <li>Click Add Pipeline</li> <li>Enter repository URL: <code>https://github.com/your-org/nf-pooled-cellpainting</code></li> <li>Select compute environment</li> <li>Configure default parameters</li> </ol>"},{"location":"usage/seqera-platform/#launching-pipelines","title":"Launching Pipelines","text":""},{"location":"usage/seqera-platform/#via-web-interface","title":"Via Web Interface","text":"<ol> <li>Navigate to Launchpad</li> <li>Select nf-pooled-cellpainting</li> <li>Configure run parameters:</li> <li>Input samplesheet (S3/Azure/GCS path or local upload)</li> <li>Output directory</li> <li>CellProfiler pipelines</li> <li>QC parameters</li> <li>Click Launch</li> </ol>"},{"location":"usage/seqera-platform/#via-tower-cli","title":"Via Tower CLI","text":"<pre><code># Install Tower CLI\npip install tower-cli\n\n# Configure credentials\ntw login\n\n# Launch pipeline\ntw launch \\\n  your-org/nf-pooled-cellpainting \\\n  --compute-env my-compute-env \\\n  --params-file params.json\n</code></pre>"},{"location":"usage/seqera-platform/#via-nextflow","title":"Via Nextflow","text":"<p>Add Seqera Platform integration:</p> <pre><code>nextflow run your-org/nf-pooled-cellpainting \\\n  --input s3://bucket/samplesheet.csv \\\n  --outdir s3://bucket/results/ \\\n  -with-tower \\\n  -resume\n</code></pre>"},{"location":"usage/seqera-platform/#configuration","title":"Configuration","text":""},{"location":"usage/seqera-platform/#pipeline-parameters","title":"Pipeline Parameters","text":"<p>Create <code>params.json</code>:</p> <pre><code>{\n  \"input\": \"s3://my-bucket/samplesheet.csv\",\n  \"barcodes\": \"s3://my-bucket/barcodes.csv\",\n  \"outdir\": \"s3://my-bucket/results/\",\n\n  \"painting_illumcalc_cppipe\": \"s3://my-bucket/pipelines/painting_illumcalc.cppipe\",\n  \"painting_illumapply_cppipe\": \"s3://my-bucket/pipelines/painting_illumapply.cppipe\",\n\n  \"cp_img_overlap_pct\": 10,\n  \"range_skip\": 16,\n\n  \"qc_painting_passed\": true,\n  \"qc_barcoding_passed\": true\n}\n</code></pre>"},{"location":"usage/seqera-platform/#compute-environment-configuration","title":"Compute Environment Configuration","text":"<p>Configure process-specific resources:</p> <pre><code>// In nextflow.config or custom config\nprocess {\n    withName: 'CELLPROFILER_ILLUMCALC' {\n        cpus = 16\n        memory = 64.GB\n        time = 8.h\n        queue = 'large'\n    }\n\n    withName: 'CELLPROFILER_ILLUMAPPLY' {\n        cpus = 8\n        memory = 32.GB\n        time = 4.h\n        queue = 'medium'\n    }\n\n    withName: 'FIJI_.*' {\n        cpus = 4\n        memory = 16.GB\n        time = 2.h\n    }\n}\n</code></pre>"},{"location":"usage/seqera-platform/#cloud-storage-integration","title":"Cloud Storage Integration","text":""},{"location":"usage/seqera-platform/#aws-s3","title":"AWS S3","text":"<p>Configure S3 access:</p> <pre><code>aws {\n    accessKey = '&lt;YOUR_ACCESS_KEY&gt;'\n    secretKey = '&lt;YOUR_SECRET_KEY&gt;'\n    region = 'us-east-1'\n}\n</code></pre> <p>Or use IAM roles (recommended):</p> <pre><code>aws {\n    region = 'us-east-1'\n}\n</code></pre> <p>Example paths:</p> <pre><code>--input s3://my-bucket/data/samplesheet.csv\n--outdir s3://my-bucket/results/\n</code></pre>"},{"location":"usage/seqera-platform/#azure-blob-storage","title":"Azure Blob Storage","text":"<pre><code>azure {\n    storage {\n        accountName = '&lt;YOUR_ACCOUNT&gt;'\n        accountKey = '&lt;YOUR_KEY&gt;'\n    }\n}\n</code></pre> <p>Example paths:</p> <pre><code>--input az://container/samplesheet.csv\n--outdir az://container/results/\n</code></pre>"},{"location":"usage/seqera-platform/#google-cloud-storage","title":"Google Cloud Storage","text":"<pre><code>google {\n    project = 'my-project'\n    region = 'us-central1'\n}\n</code></pre> <p>Example paths:</p> <pre><code>--input gs://my-bucket/samplesheet.csv\n--outdir gs://my-bucket/results/\n</code></pre>"},{"location":"usage/seqera-platform/#monitoring","title":"Monitoring","text":""},{"location":"usage/seqera-platform/#real-time-dashboard","title":"Real-time Dashboard","text":"<p>Seqera Platform provides:</p> <ul> <li>Task progress: See which tasks are running, completed, or failed</li> <li>Resource usage: CPU, memory, and time per task</li> <li>Cost tracking: Estimated cloud costs</li> <li>Logs: Live logs for each task</li> </ul>"},{"location":"usage/seqera-platform/#notifications","title":"Notifications","text":"<p>Configure notifications:</p> <ol> <li>Go to Settings \u2192 Notifications</li> <li>Add webhook or email endpoint</li> <li>Select events: pipeline started, completed, failed</li> </ol>"},{"location":"usage/seqera-platform/#reports","title":"Reports","text":"<p>Download execution reports:</p> <ul> <li>Execution timeline</li> <li>Resource usage charts</li> <li>Task failure summaries</li> </ul>"},{"location":"usage/seqera-platform/#cost-optimization","title":"Cost Optimization","text":""},{"location":"usage/seqera-platform/#spot-instances","title":"Spot Instances","text":"<p>Use spot/preemptible instances for cost savings:</p> <pre><code>process {\n    queue = 'spot'\n    errorStrategy = 'retry'\n    maxRetries = 3\n}\n</code></pre>"},{"location":"usage/seqera-platform/#resource-allocation","title":"Resource Allocation","text":"<p>Right-size process resources:</p> <pre><code>process {\n    // Avoid over-allocation\n    withName: 'CELLPROFILER_.*' {\n        cpus = { task.attempt == 1 ? 8 : 16 }\n        memory = { task.attempt == 1 ? 32.GB : 64.GB }\n    }\n}\n</code></pre>"},{"location":"usage/seqera-platform/#auto-scaling","title":"Auto-scaling","text":"<p>Configure compute environment auto-scaling:</p> <ul> <li>Min instances: 0 (for cost savings)</li> <li>Max instances: Based on workload</li> <li>Scaling policy: Scale up quickly, scale down slowly</li> </ul>"},{"location":"usage/seqera-platform/#hpc-integration","title":"HPC Integration","text":""},{"location":"usage/seqera-platform/#slurm-example","title":"SLURM Example","text":"<pre><code>process {\n    executor = 'slurm'\n    queue = 'normal'\n    clusterOptions = '--account=myaccount'\n\n    withName: 'CELLPROFILER_.*' {\n        cpus = 16\n        memory = 64.GB\n        time = 8.h\n        queue = 'large'\n    }\n}\n</code></pre>"},{"location":"usage/seqera-platform/#sge-example","title":"SGE Example","text":"<pre><code>process {\n    executor = 'sge'\n    penv = 'smp'\n    queue = 'all.q'\n\n    withName: 'CELLPROFILER_.*' {\n        cpus = 16\n        memory = '64G'\n        time = '8h'\n    }\n}\n</code></pre>"},{"location":"usage/seqera-platform/#best-practices","title":"Best Practices","text":"<ol> <li>Use cloud storage: Store input/output data in cloud buckets</li> <li>Test locally first: Validate with small dataset before scaling</li> <li>Monitor costs: Track resource usage and optimize</li> <li>Use spot instances: Reduce costs with preemptible VMs</li> <li>Configure retries: Handle transient cloud failures</li> <li>Enable resume: Always use <code>-resume</code> for failed runs</li> <li>Version control: Tag pipeline releases for reproducibility</li> </ol>"},{"location":"usage/seqera-platform/#troubleshooting","title":"Troubleshooting","text":""},{"location":"usage/seqera-platform/#authentication-issues","title":"Authentication Issues","text":"<p>Check credentials:</p> <pre><code># AWS\naws s3 ls s3://my-bucket/\n\n# Azure\naz storage blob list --account-name myaccount --container-name mycontainer\n\n# Google Cloud\ngsutil ls gs://my-bucket/\n</code></pre>"},{"location":"usage/seqera-platform/#resource-limits","title":"Resource Limits","text":"<p>Increase compute environment limits:</p> <ul> <li>Max instances</li> <li>Max CPUs</li> <li>Max memory</li> </ul>"},{"location":"usage/seqera-platform/#network-issues","title":"Network Issues","text":"<p>Ensure compute environment can access:</p> <ul> <li>Pipeline repository (GitHub/GitLab)</li> <li>Cloud storage (S3/Azure/GCS)</li> <li>Container registries</li> </ul>"},{"location":"usage/seqera-platform/#next-steps","title":"Next Steps","text":"<ul> <li>Parameters Reference - Configure pipeline</li> <li>Architecture - Understand pipeline design</li> <li>Troubleshooting - Solve common issues</li> </ul>"}]}