/*
 * NOTE: This test requires corrected TIFF images from CELLPROFILER_ILLUMAPPLY as input.
 * The test data uses illumination-corrected images from the Cell Painting pipeline.
 * These are multi-site images that will be stitched together and cropped using Fiji/ImageJ.
 */

nextflow_process {

    name "Test Process FIJI_STITCHCROP"
    script "../main.nf"
    process "FIJI_STITCHCROP"

    tag "fiji"
    tag "fiji/stitchcrop"

    test("fiji - stitchcrop - painting - corrected_images") {

        when {
            process {
                """
                input[0] = [
                    [batch:'Batch1', plate:'Plate1', arm:'painting', well:'A1', id:'Batch1_Plate1_painting_A1'],
                    [
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected/painting/Plate1/Plate1-A1-0/Plate_Plate1_Well_A1_Site_0_CorrCHN2.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected/painting/Plate1/Plate1-A1-1/Plate_Plate1_Well_A1_Site_1_CorrCHN2.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected/painting/Plate1/Plate1-A1-2/Plate_Plate1_Well_A1_Site_2_CorrCHN2.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected/painting/Plate1/Plate1-A1-3/Plate_Plate1_Well_A1_Site_3_CorrCHN2.tiff")
                    ]
                ]
                // Stitch script
                input[1] = file("\${projectDir}/bin/stitch_crop.py", checkIfExists: true)
                input[2] = 25
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() }
            )
        }

    }

    test("fiji - stitchcrop - stub") {

        options "-stub"

        when {
            process {
                """
                // Same input as regular test
                input[0] = [
                    [batch:'Batch1', plate:'Plate1', arm:'painting', well:'A1', id:'Batch1_Plate1_painting_A1'],
                    [
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected/painting/Plate1/Plate1-A1-0/Plate_Plate1_Well_A1_Site_0_CorrCHN2.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected/painting/Plate1/Plate1-A1-1/Plate_Plate1_Well_A1_Site_1_CorrCHN2.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected/painting/Plate1/Plate1-A1-2/Plate_Plate1_Well_A1_Site_2_CorrCHN2.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected/painting/Plate1/Plate1-A1-3/Plate_Plate1_Well_A1_Site_3_CorrCHN2.tiff")
                    ]
                ]
                input[1] = file("\${projectDir}/bin/stitch_crop.py", checkIfExists: true)
                input[2] = 25
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() }
            )
        }
    }

}
