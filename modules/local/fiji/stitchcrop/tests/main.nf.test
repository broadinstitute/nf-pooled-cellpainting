/*
 * NOTE: This test requires corrected TIFF images from CELLPROFILER_ILLUMAPPLY as input.
 * The test data uses illumination-corrected images from the Cell Painting pipeline.
 * These are multi-site images that will be stitched together and cropped using Fiji/ImageJ.
 */

nextflow_process {

    name "Test Process FIJI_STITCHCROP"
    script "../main.nf"
    process "FIJI_STITCHCROP"

    tag "fiji"
    tag "fiji/stitchcrop"

    test("fiji - stitchcrop - painting - corrected_images") {

        when {
            process {
                """
                // Input: corrected images from CELLPROFILER_ILLUMAPPLY (4 sites from well A1)
                // These images have been illumination-corrected and will be stitched into a single image
                input[0] = [
                    [batch:'Batch1', plate:'Plate1', arm:'painting', well:'A1', id:'Batch1_Plate1_painting_A1'],
                    [
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images/Plate1/corrected/Plate_Plate1_Well_A01_Site_0_CorrPhalloidin.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images/Plate1/corrected/Plate_Plate1_Well_A01_Site_0_CorrCHN2.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images/Plate1/corrected/Plate_Plate1_Well_A01_Site_0_CorrDNA.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images/Plate1/corrected/Plate_Plate1_Well_A01_Site_1_CorrPhalloidin.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images/Plate1/corrected/Plate_Plate1_Well_A01_Site_1_CorrCHN2.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images/Plate1/corrected/Plate_Plate1_Well_A01_Site_1_CorrDNA.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images/Plate1/corrected/Plate_Plate1_Well_A01_Site_2_CorrPhalloidin.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images/Plate1/corrected/Plate_Plate1_Well_A01_Site_2_CorrCHN2.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images/Plate1/corrected/Plate_Plate1_Well_A01_Site_2_CorrDNA.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images/Plate1/corrected/Plate_Plate1_Well_A01_Site_3_CorrPhalloidin.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images/Plate1/corrected/Plate_Plate1_Well_A01_Site_3_CorrCHN2.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images/Plate1/corrected/Plate_Plate1_Well_A01_Site_3_CorrDNA.tiff")
                    ]
                ]
                // Track type: painting or barcoding
                input[1] = 'painting'
                // Stitch script
                input[2] = file("\${projectDir}/bin/stitch_crop.py", checkIfExists: true)
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(
                    process.out.stitched,
                    process.out.cropped,
                    process.out.downsampled,
                    process.out.versions
                ).match() }
            )
        }

    }

    test("fiji - stitchcrop - painting - corrected_images - stub") {

        options "-stub"

        when {
            process {
                """
                // Same input as regular test
                input[0] = [
                    [batch:'Batch1', plate:'Plate1', arm:'painting', well:'A1', id:'Batch1_Plate1_painting_A1'],
                    [
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images/Plate1/corrected/Plate_Plate1_Well_A01_Site_0_CorrPhalloidin.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images/Plate1/corrected/Plate_Plate1_Well_A01_Site_0_CorrCHN2.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images/Plate1/corrected/Plate_Plate1_Well_A01_Site_0_CorrDNA.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images/Plate1/corrected/Plate_Plate1_Well_A01_Site_1_CorrPhalloidin.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images/Plate1/corrected/Plate_Plate1_Well_A01_Site_1_CorrCHN2.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images/Plate1/corrected/Plate_Plate1_Well_A01_Site_1_CorrDNA.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images/Plate1/corrected/Plate_Plate1_Well_A01_Site_2_CorrPhalloidin.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images/Plate1/corrected/Plate_Plate1_Well_A01_Site_2_CorrCHN2.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images/Plate1/corrected/Plate_Plate1_Well_A01_Site_2_CorrDNA.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images/Plate1/corrected/Plate_Plate1_Well_A01_Site_3_CorrPhalloidin.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images/Plate1/corrected/Plate_Plate1_Well_A01_Site_3_CorrCHN2.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images/Plate1/corrected/Plate_Plate1_Well_A01_Site_3_CorrDNA.tiff")
                    ]
                ]
                input[1] = 'painting'
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() }
            )
        }
    }

}
