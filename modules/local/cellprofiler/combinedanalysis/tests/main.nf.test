nextflow_process {

    name "Test Process CELLPROFILER_COMBINEDANALYSIS"
    script "../main.nf"
    process "CELLPROFILER_COMBINEDANALYSIS"

    tag "cellprofiler"
    tag "cellprofiler/combinedanalysis"

    test("cellprofiler - combinedanalysis - cropped_images") {

        when {
            process {
                """
                // NOTE: This test uses cropped images from both cell painting and barcoding
                // The cropped images should be from the same plate, well, and site
                // Input[0]: Meta map + cropped images (both painting and barcoding) + image_metas
                // Input[1]: CellProfiler combined analysis pipeline
                // Input[2]: Barcodes CSV file
                // Input[3]: CellProfiler plugins

                input[0] = [
                    [ id:'Batch1_Plate1_A1_1', batch:'Batch1', plate:'Plate1', well:'A1', site:1 ],
                    [
                        // Cell painting corrected images
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/painting/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_CorrCHN2.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/painting/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_CorrDNA.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/painting/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_CorrPhalloidin.tiff"),
                        // Barcoding cropped images from preprocess module
                        // Cycle 1
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_Cycle01_A.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_Cycle01_C.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_Cycle01_DNA.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_Cycle01_G.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_Cycle01_T.tiff"),
                        // Cycle 2
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_Cycle02_A.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_Cycle02_C.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_Cycle02_G.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_Cycle02_T.tiff"),
                        // Cycle 3
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_Cycle03_A.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_Cycle03_C.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_Cycle03_G.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_Cycle03_T.tiff"),
                    ],
                    [
                        // Painting images
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_CorrCHN2.tiff', type:'cellpainting', channel:'CHN2'],
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_CorrDNA.tiff', type:'cellpainting', channel:'DNA'],
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_CorrPhalloidin.tiff', type:'cellpainting', channel:'Phalloidin'],
                        // Barcoding images - Cycle 1
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_Cycle01_A.tiff', type:'barcoding', cycle:1, channel:'A'],
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_Cycle01_C.tiff', type:'barcoding', cycle:1, channel:'C'],
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_Cycle01_DNA.tiff', type:'barcoding', cycle:1, channel:'DNA'],
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_Cycle01_G.tiff', type:'barcoding', cycle:1, channel:'G'],
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_Cycle01_T.tiff', type:'barcoding', cycle:1, channel:'T'],
                        // Barcoding images - Cycle 2
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_Cycle02_A.tiff', type:'barcoding', cycle:2, channel:'A'],
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_Cycle02_C.tiff', type:'barcoding', cycle:2, channel:'C'],
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_Cycle02_G.tiff', type:'barcoding', cycle:2, channel:'G'],
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_Cycle02_T.tiff', type:'barcoding', cycle:2, channel:'T'],
                        // Barcoding images - Cycle 3
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_Cycle03_A.tiff', type:'barcoding', cycle:3, channel:'A'],
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_Cycle03_C.tiff', type:'barcoding', cycle:3, channel:'C'],
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_Cycle03_G.tiff', type:'barcoding', cycle:3, channel:'G'],
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_Cycle03_T.tiff', type:'barcoding', cycle:3, channel:'T']
                    ]
                ]
                input[1] = file("\${projectDir}/assets/cellprofiler/combined_analysis.cppipe", checkIfExists: true)
                input[2] = file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/workspace/metadata/Barcodes.csv", checkIfExists: true)
                input[3] = [
                    file(params.callbarcodes_plugin, checkIfExists: true)
                ]
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(
                    process.out.overlay_images,
                    process.out.csv_stats.get(0).get(1).findAll {
                        file(it).name != "Experiment.csv" &&
                        file(it).name != "Image.csv" &&
                        file(it).name != "BarcodeFoci.csv" &&
                        file(it).name != "Cells.csv" &&
                        file(it).name != "Cytoplasm.csv" &&
                        file(it).name != "Foci.csv" &&
                        file(it).name != "Nuclei.csv"
                    },
                    process.out.load_data_csv,
                    process.out.versions
                ).match() },
                { assert process.out.csv_stats.get(0).get(1).any { file(it).name == "Experiment.csv" } },
                { assert process.out.csv_stats.get(0).get(1).any { file(it).name == "Image.csv" } },
                { assert process.out.csv_stats.get(0).get(1).any { file(it).name == "BarcodeFoci.csv" } },
                { assert process.out.csv_stats.get(0).get(1).any { file(it).name == "Cells.csv" } },
                { assert process.out.csv_stats.get(0).get(1).any { file(it).name == "Cytoplasm.csv" } },
                { assert process.out.csv_stats.get(0).get(1).any { file(it).name == "Foci.csv" } },
                { assert process.out.csv_stats.get(0).get(1).any { file(it).name == "Nuclei.csv" } }
            )
        }

    }

    test("cellprofiler - combinedanalysis - cropped_images - stub") {

        options "-stub"

        when {
            process {
                """
                // NOTE: This test uses cropped images from both cell painting and barcoding
                // The cropped images should be from the same plate, well, and site
                // Input[0]: Meta map + cropped images (both painting and barcoding) + image_metas
                // Input[1]: CellProfiler combined analysis pipeline
                // Input[2]: Barcodes CSV file
                // Input[3]: CellProfiler plugins

                input[0] = [
                    [ id:'Batch1_Plate1_A1_1', batch:'Batch1', plate:'Plate1', well:'A1', site:1 ],
                    [
                        // Cell painting corrected images
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/painting/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_CorrCHN2.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/painting/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_CorrDNA.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/painting/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_CorrPhalloidin.tiff"),
                        // Barcoding cropped images from preprocess module
                        // Cycle 1
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_Cycle01_A.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_Cycle01_C.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_Cycle01_DNA.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_Cycle01_G.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_Cycle01_T.tiff"),
                        // Cycle 2
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_Cycle02_A.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_Cycle02_C.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_Cycle02_G.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_Cycle02_T.tiff"),
                        // Cycle 3
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_Cycle03_A.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_Cycle03_C.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_Cycle03_G.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Plate_Plate1_Well_A1_Site_1_Cycle03_T.tiff"),
                    ],
                    [
                        // Painting images
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_CorrCHN2.tiff', type:'cellpainting', channel:'CHN2'],
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_CorrDNA.tiff', type:'cellpainting', channel:'DNA'],
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_CorrPhalloidin.tiff', type:'cellpainting', channel:'Phalloidin'],
                        // Barcoding images - Cycle 1
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_Cycle01_A.tiff', type:'barcoding', cycle:1, channel:'A'],
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_Cycle01_C.tiff', type:'barcoding', cycle:1, channel:'C'],
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_Cycle01_DNA.tiff', type:'barcoding', cycle:1, channel:'DNA'],
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_Cycle01_G.tiff', type:'barcoding', cycle:1, channel:'G'],
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_Cycle01_T.tiff', type:'barcoding', cycle:1, channel:'T'],
                        // Barcoding images - Cycle 2
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_Cycle02_A.tiff', type:'barcoding', cycle:2, channel:'A'],
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_Cycle02_C.tiff', type:'barcoding', cycle:2, channel:'C'],
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_Cycle02_G.tiff', type:'barcoding', cycle:2, channel:'G'],
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_Cycle02_T.tiff', type:'barcoding', cycle:2, channel:'T'],
                        // Barcoding images - Cycle 3
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_Cycle03_A.tiff', type:'barcoding', cycle:3, channel:'A'],
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_Cycle03_C.tiff', type:'barcoding', cycle:3, channel:'C'],
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_Cycle03_G.tiff', type:'barcoding', cycle:3, channel:'G'],
                        [plate:'Plate1', batch:'Batch1', well:'A1', site:1, filename:'Plate_Plate1_Well_A1_Site_1_Cycle03_T.tiff', type:'barcoding', cycle:3, channel:'T']
                    ]
                ]
                input[1] = file("\${projectDir}/assets/cellprofiler/combined_analysis.cppipe", checkIfExists: true)
                input[2] = file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/workspace/metadata/Barcodes.csv", checkIfExists: true)
                input[3] = [
                    file(params.callbarcodes_plugin, checkIfExists: true)
                ]
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() }
            )
        }

    }

}
