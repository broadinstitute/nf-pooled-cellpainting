nextflow_process {

    name "Test Process CELLPROFILER_COMBINEDANALYSIS"
    script "../main.nf"
    process "CELLPROFILER_COMBINEDANALYSIS"

    tag "cellprofiler"
    tag "cellprofiler/combinedanalysis"

    test("cellprofiler - combinedanalysis - cropped_images") {

        when {
            process {
                """
                // NOTE: This test uses cropped images from both cell painting and barcoding
                // The cropped images should be from the same plate, well, and site
                // Input[0]: Meta map + cropped images (both painting and barcoding)
                // Input[1]: CellProfiler combined analysis pipeline
                // Input[2]: Barcodes CSV file
                // Input[3]: CellProfiler plugins

                input[0] = [
                    [ id:'Batch1_Plate1_A1_1', batch:'Batch1', plate:'Plate1', well:'A1', site:1 ],
                    [
                        // Cell painting corrected images
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/painting/Plate1/Plate1-A1/CorrCHN2/CorrCHN2_Site_1.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/painting/Plate1/Plate1-A1/CorrDNA/CorrDNA_Site_1.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/painting/Plate1/Plate1-A1/CorrPhalloidin/CorrPhalloidin_Site_1.tiff"),
                        // Barcoding cropped images from preprocess module
                        // Cycle 1
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Cycle01_A/Cycle01_A_Site_1.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Cycle01_C/Cycle01_C_Site_1.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Cycle01_DNA/Cycle01_DNA_Site_1.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Cycle01_G/Cycle01_G_Site_1.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Cycle01_T/Cycle01_T_Site_1.tiff"),
                        // Cycle 2
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Cycle02_A/Cycle02_A_Site_1.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Cycle02_C/Cycle02_C_Site_1.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Cycle02_G/Cycle02_G_Site_1.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Cycle02_T/Cycle02_T_Site_1.tiff"),
                        // Cycle 3
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Cycle03_A/Cycle03_A_Site_1.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Cycle03_C/Cycle03_C_Site_1.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Cycle03_G/Cycle03_G_Site_1.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Cycle03_T/Cycle03_T_Site_1.tiff"),
                    ]
                ]
                input[1] = file("\${projectDir}/assets/cellprofiler/combined_analysis.cppipe", checkIfExists: true)
                input[2] = file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/workspace/metadata/Barcodes.csv", checkIfExists: true)
                input[3] = [
                    file("\${projectDir}/assets/cellprofiler_plugins/callbarcodes.py", checkIfExists: true)
                ]
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(
                    process.out.overlay_images,
                    process.out.csv_stats.get(0).get(1).findAll {
                        file(it).name != "CombinedAnalysis_Experiment.csv" &&
                        file(it).name != "CombinedAnalysis_Image.csv"
                    },
                    process.out.load_data_csv,
                    process.out.versions
                ).match() }
            )
        }

    }

    test("cellprofiler - combinedanalysis - cropped_images - stub") {

        options "-stub"

        when {
            process {
                """
                // NOTE: This test uses cropped images from both cell painting and barcoding
                // The cropped images should be from the same plate, well, and site
                // Input[0]: Meta map + cropped images (both painting and barcoding)
                // Input[1]: CellProfiler combined analysis pipeline
                // Input[2]: Barcodes CSV file
                // Input[3]: CellProfiler plugins

                input[0] = [
                    [ id:'Batch1_Plate1_A1_1', batch:'Batch1', plate:'Plate1', well:'A1', site:1 ],
                    [
                        // Cell painting corrected images
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/painting/Plate1/Plate1-A1/CorrCHN2/CorrCHN2_Site_1.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/painting/Plate1/Plate1-A1/CorrDNA/CorrDNA_Site_1.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/painting/Plate1/Plate1-A1/CorrPhalloidin/CorrPhalloidin_Site_1.tiff"),
                        // Barcoding cropped images from preprocess module
                        // Cycle 1
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Cycle01_A/Cycle01_A_Site_1.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Cycle01_C/Cycle01_C_Site_1.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Cycle01_DNA/Cycle01_DNA_Site_1.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Cycle01_G/Cycle01_G_Site_1.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Cycle01_T/Cycle01_T_Site_1.tiff"),
                        // Cycle 2
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Cycle02_A/Cycle02_A_Site_1.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Cycle02_C/Cycle02_C_Site_1.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Cycle02_G/Cycle02_G_Site_1.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Cycle02_T/Cycle02_T_Site_1.tiff"),
                        // Cycle 3
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Cycle03_A/Cycle03_A_Site_1.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Cycle03_C/Cycle03_C_Site_1.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Cycle03_G/Cycle03_G_Site_1.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected_cropped/barcoding/Plate1/Plate1-A1/Cycle03_T/Cycle03_T_Site_1.tiff"),
                    ]
                ]
                input[1] = file("\${projectDir}/assets/cellprofiler/combined_analysis.cppipe", checkIfExists: true)
                input[2] = file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/workspace/metadata/Barcodes.csv", checkIfExists: true)
                input[3] = [
                    file("\${projectDir}/assets/cellprofiler_plugins/callbarcodes.py", checkIfExists: true)
                ]
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() }
            )
        }

    }

}
