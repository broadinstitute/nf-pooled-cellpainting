nextflow_process {

    name "Test Process CELLPROFILER_SEGCHECK"
    script "../main.nf"
    process "CELLPROFILER_SEGCHECK"

    tag "cellprofiler"
    tag "cellprofiler/segcheck"

    test("cellprofiler - segcheck - painting") {

        when {
            process {
                """
                input[0] = [
                    [batch:'Batch1', plate:'Plate1', arm:'painting', well:'A1', id:'Batch1_Plate1_painting_A1'],
                    [
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected/painting/Plate1/Plate1-A1-0/Plate_Plate1_Well_A1_Site_0_CorrCHN2.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected/painting/Plate1/Plate1-A1-0/Plate_Plate1_Well_A1_Site_0_CorrDNA.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected/painting/Plate1/Plate1-A1-0/Plate_Plate1_Well_A1_Site_0_CorrPhalloidin.tiff"),
                    ],
                    [
                        [well:'A1', site:0, filename:'Plate_Plate1_Well_A1_Site_0_CorrCHN2.tiff', channel:'CHN2'],
                        [well:'A1', site:0, filename:'Plate_Plate1_Well_A1_Site_0_CorrDNA.tiff', channel:'DNA'],
                        [well:'A1', site:0, filename:'Plate_Plate1_Well_A1_Site_0_CorrPhalloidin.tiff', channel:'Phalloidin']
                    ]
                ]
                input[1] = file("\${projectDir}/assets/cellprofiler/painting_segcheck.cppipe", checkIfExists: true)
                input[2] = 1
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out.segcheck_res.get(0).get(1).findAll { file(it).name != "SegmentationCheck_Experiment.csv" && file(it).name != "SegmentationCheck_Image.csv" }).match() }
            )
        }

    }

    test("cellprofiler - segcheck - stub") {

        options "-stub"

        when {
            process {
                """
                input[0] = [
                    [batch:'Batch1', plate:'Plate1', arm:'painting', well:'A1', id:'Batch1_Plate1_painting_A1'],
                    [
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected/painting/Plate1/Plate1-A1-0/Plate_Plate1_Well_A1_Site_0_CorrCHN2.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected/painting/Plate1/Plate1-A1-0/Plate_Plate1_Well_A1_Site_0_CorrDNA.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/images_corrected/painting/Plate1/Plate1-A1-0/Plate_Plate1_Well_A1_Site_0_CorrPhalloidin.tiff"),
                    ],
                    [
                        [well:'A1', site:0, filename:'Plate_Plate1_Well_A1_Site_0_CorrCHN2.tiff', channel:'CHN2'],
                        [well:'A1', site:0, filename:'Plate_Plate1_Well_A1_Site_0_CorrDNA.tiff', channel:'DNA'],
                        [well:'A1', site:0, filename:'Plate_Plate1_Well_A1_Site_0_CorrPhalloidin.tiff', channel:'Phalloidin']
                    ]
                ]
                input[1] = file("\${projectDir}/assets/cellprofiler/painting_segcheck.cppipe", checkIfExists: true)
                input[2] = 1
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() }
            )
        }

    }

}
