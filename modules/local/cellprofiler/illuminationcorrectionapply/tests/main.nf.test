nextflow_process {

    name "Test Process CELLPROFILER_ILLUMINATIONCORRECTIONAPPLY"
    script "../main.nf"
    process "CELLPROFILER_ILLUMINATIONCORRECTIONAPPLY"

    tag "modules"
    tag "modules_"
    tag "cellprofiler"
    tag "cellprofiler/illuminationcorrectionapply"

    test("cellprofiler - illuminationcorrectionapply") {

        when {
            process {
                """
                input[0] = [
                    [batch:'Batch1', plate:'Plate1', channels:'Phalloidin,CHN2-AF488,DNA', id:'Batch1_Plate1_Phalloidin,CHN2-AF488,DNA'], 'Phalloidin,CHN2-AF488,DNA',
                    [   file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0000_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0000.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0001_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0001.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0002_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0002.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0003_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0003.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA2_PointA2_0000_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq1025.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA2_PointA2_0001_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq1026.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA2_PointA2_0002_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq1027.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA2_PointA2_0003_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq1028.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellB1_PointB1_0000_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq3075.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellB1_PointB1_0001_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq3076.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellB1_PointB1_0002_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq3077.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellB1_PointB1_0003_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq3078.ome.tiff")],
                    [   file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/Batch1/illum/Plate1/Plate1_IllumPhalloidin.npy"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/Batch1/illum/Plate1/Plate1_IllumCHN2.npy"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/Batch1/illum/Plate1/Plate1_IllumDNA.npy")
                    ],
                        file("${projectDir}/modules/local/cellprofiler/illuminationcorrectionapply/tests/load_data.csv", checkIfExists: true)
                ]
                input[1] = "${projectDir}/assets/cellprofiler/cp_illumination_apply.cppipe.template"
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out.illumination_corrections).match() }
            )
        }

    }

    test("cellprofiler - illuminationcorrectionapply - stub") {

        options "-stub"

        when {
            process {
                """
                input[0] = [
                    [batch:'Batch1', plate:'Plate1', channels:'Phalloidin,CHN2-AF488,DNA', id:'Batch1_Plate1_Phalloidin,CHN2-AF488,DNA'], 'Phalloidin,CHN2-AF488,DNA',
                    [   file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0000_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0000.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0001_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0001.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0002_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0002.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0003_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0003.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA2_PointA2_0000_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq1025.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA2_PointA2_0001_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq1026.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA2_PointA2_0002_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq1027.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA2_PointA2_0003_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq1028.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellB1_PointB1_0000_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq3075.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellB1_PointB1_0001_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq3076.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellB1_PointB1_0002_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq3077.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellB1_PointB1_0003_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq3078.ome.tiff")],
                    [   file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/Batch1/illum/Plate1/Plate1_IllumPhalloidin.npy"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/Batch1/illum/Plate1/Plate1_IllumCHN2.npy"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/Batch1/illum/Plate1/Plate1_IllumDNA.npy")
                    ],
                        file("${projectDir}/modules/local/cellprofiler/illuminationcorrectionapply/tests/load_data.csv", checkIfExists: true)
                ]
                input[1] = "${projectDir}/assets/cellprofiler/cp_illumination_apply.cppipe.template"
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out.illumination_corrections).match() }
            )
        }
    }
}
