nextflow_process {

    name "Test Process CELLPROFILER_ILLUMAPPLY"
    script "../main.nf"
    process "CELLPROFILER_ILLUMAPPLY"

    tag "cellprofiler"
    tag "cellprofiler/illumapply"

    test("cellprofiler - illumapply - painting") {

        when {
            process {
                """
                input[0] = [
                    [batch:'Batch1', plate:'Plate1', arm:'CP', well:'A01', id:'Batch1_Plate1_painting_A1'],
                    'Phalloidin,CHN2,DNA',
                    null,
                    [   file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1_sub25/Source1/images/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0000_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0000.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1_sub25/Source1/images/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0001_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0001.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1_sub25/Source1/images/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0002_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0002.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1_sub25/Source1/images/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0003_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0003.ome.tiff")
                    ],
                    [   [plate:'Plate1', batch:'Batch1', arm:'CP', well:'A1', site:0, channels:['Phalloidin', 'CHN2', 'DNA'], filename:'WellA1_PointA1_0000_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0000.ome.tiff'],
                        [plate:'Plate1', batch:'Batch1', arm:'CP', well:'A1', site:1, channels:['Phalloidin', 'CHN2', 'DNA'], filename:'WellA1_PointA1_0001_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0001.ome.tiff'],
                        [plate:'Plate1', batch:'Batch1', arm:'CP', well:'A1', site:2, channels:['Phalloidin', 'CHN2', 'DNA'], filename:'WellA1_PointA1_0002_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0002.ome.tiff'],
                        [plate:'Plate1', batch:'Batch1', arm:'CP', well:'A1', site:3, channels:['Phalloidin', 'CHN2', 'DNA'], filename:'WellA1_PointA1_0003_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0003.ome.tiff']],
                    [   file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/illum/Plate1/Plate1_IllumPhalloidin.npy"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/illum/Plate1/Plate1_IllumCHN2.npy"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/illum/Plate1/Plate1_IllumDNA.npy")
                    ]
                ]
                input[1] = file("${projectDir}/assets/cellprofiler/painting_illumapply.cppipe")
                input[2] = false
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out.corrected_images.get(0).get(1).findAll { file(it).name != "PaintingIllumApplication_Experiment.csv" && file(it).name != "PaintingIllumApplication_Image.csv" }).match() }
            )
        }

    }

    test("cellprofiler - illumapply - stub") {

        options "-stub"

        when {
            process {
                """
                input[0] = [
                    [batch:'Batch1', plate:'Plate1', arm:'CP', well:'A01', id:'Batch1_Plate1_painting_A1'],
                    'Phalloidin,CHN2,DNA',
                    null,
                    [   file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1_sub25/Source1/images/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0000_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0000.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1_sub25/Source1/images/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0001_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0001.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1_sub25/Source1/images/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0002_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0002.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1_sub25/Source1/images/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0003_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0003.ome.tiff")
                    ],
                    [   [plate:'Plate1', batch:'Batch1', arm:'CP', well:'A1', site:0, channels:['Phalloidin', 'CHN2', 'DNA'], filename:'WellA1_PointA1_0000_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0000.ome.tiff'],
                        [plate:'Plate1', batch:'Batch1', arm:'CP', well:'A1', site:1, channels:['Phalloidin', 'CHN2', 'DNA'], filename:'WellA1_PointA1_0001_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0001.ome.tiff'],
                        [plate:'Plate1', batch:'Batch1', arm:'CP', well:'A1', site:2, channels:['Phalloidin', 'CHN2', 'DNA'], filename:'WellA1_PointA1_0002_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0002.ome.tiff'],
                        [plate:'Plate1', batch:'Batch1', arm:'CP', well:'A1', site:3, channels:['Phalloidin', 'CHN2', 'DNA'], filename:'WellA1_PointA1_0003_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0003.ome.tiff']],
                    [   file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/illum/Plate1/Plate1_IllumPhalloidin.npy"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/illum/Plate1/Plate1_IllumCHN2.npy"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1-output/Source1/images/Batch1/illum/Plate1/Plate1_IllumDNA.npy")
                    ]
                ]
                input[1] = file("${projectDir}/assets/cellprofiler/painting_illumapply.cppipe")
                input[2] = false
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() }
            )
        }
    }
}
